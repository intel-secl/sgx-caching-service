/*
 * Copyright (C) 2022 Intel Corporation
 * SPDX-License-Identifier: BSD-3-Clause
 */
package resource

import (
	"bytes"
	"encoding/json"
	"intel/isecl/lib/common/v5/context"
	"intel/isecl/lib/common/v5/types/aas"
	"intel/isecl/scs/v5/config"
	"intel/isecl/scs/v5/constants"
	"intel/isecl/scs/v5/domain"
	"intel/isecl/scs/v5/domain/mocks"
	"intel/isecl/scs/v5/repository"
	"intel/isecl/scs/v5/types"
	"net/http"
	"net/http/httptest"
	"testing"
	"time"

	"github.com/google/uuid"
	"github.com/gorilla/mux"
	consts "github.com/intel-secl/intel-secl/v5/pkg/lib/common/constants"
	. "github.com/onsi/ginkgo/v2"
	. "github.com/onsi/gomega"
	"github.com/stretchr/testify/assert"
)

const (
	testConfigFilePath    = "../test/config.yml"
	trustedSGXRootCA      = "../test/trustedSGXRootCA.pem"
	intermediateSGXRootCA = "../test/intermediateSGXRootCA.pem"
	pckCertFilePath       = "../test/pck-cert.pem"
)

var _ = Describe("PlatformInfo Validation", func() {
	var router *mux.Router
	var w *httptest.ResponseRecorder
	var conf *config.Configuration
	var client domain.HttpClient

	db := getMockDatabase()
	conf = config.Load(testConfigFilePath)
	client = mocks.NewClientMock(200)

	BeforeEach(func() {
		router = mux.NewRouter()
	})

	Describe("PlatformInfo Resource validation", func() {
		Context("pushPlatformInfo request validation", func() {

			It("Should return StatusBadRequest - Insufficient roles", func() {

				PlatformInfoOps(router, db, nil, nil)

				req, err := http.NewRequest(http.MethodPost, "/platforms", nil)
				Expect(err).NotTo(HaveOccurred())

				// valid permissions added insufficient roles.
				permissions := aas.PermissionInfo{Service: constants.ServiceName, Rules: []string{constants.HostDataUpdaterGroupName}}
				req = context.SetUserPermissions(req, []aas.PermissionInfo{permissions})
				req.Header.Set("Content-Type", consts.HTTPMediaTypeJson)
				w = httptest.NewRecorder()
				router.ServeHTTP(w, req)
				Expect(w.Code).To(Equal(http.StatusInternalServerError))
			})

			It("Should return StatusForbidden - Invalid role given", func() {

				PlatformInfoOps(router, db, conf, nil)

				req, err := http.NewRequest(http.MethodPost, "/platforms", nil)
				Expect(err).NotTo(HaveOccurred())

				roleInfo := []aas.RoleInfo{{Service: constants.ServiceName, Name: "HostDataUpdaterGroupName", Context: "type=SCS"}}
				req = context.SetUserRoles(req, roleInfo)
				req.Header.Set("Content-Type", consts.HTTPMediaTypeJson)
				w = httptest.NewRecorder()
				router.ServeHTTP(w, req)
				Expect(w.Code).To(Equal(http.StatusForbidden))
			})

			It("Should return StatusBadRequest - Empty body content given", func() {

				PlatformInfoOps(router, db, conf, nil)

				req, err := http.NewRequest(http.MethodPost, "/platforms", nil)
				Expect(err).NotTo(HaveOccurred())

				// valid permissions and userroles added.
				permissions := aas.PermissionInfo{Service: constants.ServiceName, Rules: []string{constants.HostDataUpdaterGroupName}}
				req = context.SetUserPermissions(req, []aas.PermissionInfo{permissions})
				roleInfo := []aas.RoleInfo{{Service: constants.ServiceName, Name: constants.HostDataUpdaterGroupName, Context: "type=SCS"}}
				req = context.SetUserRoles(req, roleInfo)
				req.Header.Set("Content-Type", consts.HTTPMediaTypeJson)
				w = httptest.NewRecorder()
				router.ServeHTTP(w, req)
				Expect(w.Code).To(Equal(http.StatusBadRequest))
			})

			It("Should return StatusOK - Valid body content given", func() {

				platform := &types.Platform{
					QeID:     "0518145496973c5e69577195511e9080",
					PceID:    "0000",
					CPUSvn:   "1bf8deed6f929ce40bd658e61ea722eb",
					PceSvn:   "0a00",
					Encppid:  "00f51b4272163732be2101ee62dfdb175205a5179c5b5faff4b2ae103cb1150ef7d4e6041775543930600e41dd2e6aee7f40790f5a0380f6b29b1f1f7e6aad75bfa666153bb325c6db5b67f694d14bff98996c4994ce153278bfeb1b455dd4acbeacc97df6a3cd439a838218c1e07dae91a62195b803b9d3808d5b8470d46b0af3f275b6f6573871eb4eeb43ed9c5a5647729f25648fa74f1ce43621618b266abde6f44e92ce65bbbbe2c50e3e7a8b84d1ed38f53a1d99d3f15fc8c39b0ee568580c37a4eb19dbe87cd447c78f05544684701c01e64e0273dc69c27e46f732f7a7ee8cc4dfaf3b921bf6bbc3ee83f8de5f4e86039595cddaf7cadfce599f0eb92509ff2a90d189bda51fdd298fa1cffd4e8d79095f104c073a2b71cf61c727f4e5718cb7ea2f8fc6d7694bf3b40764234dfbe0d35f40f557545e1729ca639be4f1bcdc9028cb590b3ad3fd176bfea3cef13e57db057b3bae7ae8553a454515aecb21e4c58c670b19d8ee12668ab8af16d56b285153589eb85d15cd9e56fe459b",
					Fmspc:    "20606a000000",
					Ca:       "processor",
					Manifest: "178e874b49e44aa599bb3057170925b41d6e010000000000000000000000000084947ac684404189902a7e76cd658926bc010100000000000000000000000000e5db57cfd1af3e45ddfbd7f52e74a44871d542e3893c9f6f88ef999a7969eacc38e156d8233e6479997f6daa3553d902bb6a7fd6e6db21c43c13993c91c2eb95b6654b70d3e1602d5c236f9c5e8209a6a9923f49628eb7ba934913ccee4ae3df1c9ce11d0dac1c2e6ebbeb7b036e1288ad98d0aac44e5dbe3e01ea40eb7301c513c388d7e87b6630fcee23dccc28e5466a3669137e79021e386db75569606a481ac81bcd03fdc30a142bce8cca274dc044f2b40dc9abaef952bb4f0d01058d590d6950cd56bd036c7385272789e38de9b7302fafd5514248de83c18aedc9fb3c4a60754b41d8038be2c85d9e109742450b76989ff262cb0a7a979546018c7c76109ec6dd7965eead462bbd1edf6124e4a7da00de497408e44869496138cc1383f2caef7b6bf456c1f494c2b539e1741d904515414816a5096e96350b5decc84cdb9c29fe6ffa7a1982b55fe6fb258e18f03c1724b296aab446a9f4e10de1d49485f4360dfade7bc6abf70c0f1ed59c15ab30face19e3cfee43e1bee2f2800095576af52b46344ea4e7e08c2bc1d568dd01000100bcf7744b0929b513d15794280f82233b5684b73af7f86c073d1ecec86f6cd34c0000010001000000fd8f5c411b614b97a74796f08926757b39050100000000000000000000000000200000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
					HwUUID:   uuid.MustParse("9698f2c6-08a4-44e1-8c26-ce29ec3a3766"),
				}

				db.PlatformRepository().Create(platform)

				PlatformInfoOps(router, db, conf, &client)

				platformInfo := PlatformInfo{
					EncPpid:  "00f51b4272163732be2101ee62dfdb175205a5179c5b5faff4b2ae103cb1150ef7d4e6041775543930600e41dd2e6aee7f40790f5a0380f6b29b1f1f7e6aad75bfa666153bb325c6db5b67f694d14bff98996c4994ce153278bfeb1b455dd4acbeacc97df6a3cd439a838218c1e07dae91a62195b803b9d3808d5b8470d46b0af3f275b6f6573871eb4eeb43ed9c5a5647729f25648fa74f1ce43621618b266abde6f44e92ce65bbbbe2c50e3e7a8b84d1ed38f53a1d99d3f15fc8c39b0ee568580c37a4eb19dbe87cd447c78f05544684701c01e64e0273dc69c27e46f732f7a7ee8cc4dfaf3b921bf6bbc3ee83f8de5f4e86039595cddaf7cadfce599f0eb92509ff2a90d189bda51fdd298fa1cffd4e8d79095f104c073a2b71cf61c727f4e5718cb7ea2f8fc6d7694bf3b40764234dfbe0d35f40f557545e1729ca639be4f1bcdc9028cb590b3ad3fd176bfea3cef13e57db057b3bae7ae8553a454515aecb21e4c58c670b19d8ee12668ab8af16d56b285153589eb85d15cd9e56fe459b",
					PceID:    "0000",
					CPUSvn:   "1bf8deed6f929ce40bd658e61ea722eb",
					PceSvn:   "0a00",
					QeID:     "0518145496973c5e69577195511e9080",
					Manifest: "178e874b49e44aa599bb3057170925b41d6e010000000000000000000000000084947ac684404189902a7e76cd658926bc010100000000000000000000000000e5db57cfd1af3e45ddfbd7f52e74a44871d542e3893c9f6f88ef999a7969eacc38e156d8233e6479997f6daa3553d902bb6a7fd6e6db21c43c13993c91c2eb95b6654b70d3e1602d5c236f9c5e8209a6a9923f49628eb7ba934913ccee4ae3df1c9ce11d0dac1c2e6ebbeb7b036e1288ad98d0aac44e5dbe3e01ea40eb7301c513c388d7e87b6630fcee23dccc28e5466a3669137e79021e386db75569606a481ac81bcd03fdc30a142bce8cca274dc044f2b40dc9abaef952bb4f0d01058d590d6950cd56bd036c7385272789e38de9b7302fafd5514248de83c18aedc9fb3c4a60754b41d8038be2c85d9e109742450b76989ff262cb0a7a979546018c7c76109ec6dd7965eead462bbd1edf6124e4a7da00de497408e44869496138cc1383f2caef7b6bf456c1f494c2b539e1741d904515414816a5096e96350b5decc84cdb9c29fe6ffa7a1982b55fe6fb258e18f03c1724b296aab446a9f4e10de1d49485f4360dfade7bc6abf70c0f1ed59c15ab30face19e3cfee43e1bee2f2800095576af52b46344ea4e7e08c2bc1d568dd01000100bcf7744b0929b513d15794280f82233b5684b73af7f86c073d1ecec86f6cd34c0000010001000000fd8f5c411b614b97a74796f08926757b39050100000000000000000000000000200000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
					HwUUID:   "9698f2c6-08a4-44e1-8c26-ce29ec3a3766",
				}

				reqBody, _ := json.Marshal(platformInfo)
				req, err := http.NewRequest(http.MethodPost, "/platforms", bytes.NewReader(reqBody))
				Expect(err).NotTo(HaveOccurred())

				// valid permissions and userroles added.
				permissions := aas.PermissionInfo{Service: constants.ServiceName, Rules: []string{constants.HostDataUpdaterGroupName}}
				req = context.SetUserPermissions(req, []aas.PermissionInfo{permissions})
				roleInfo := []aas.RoleInfo{{Service: constants.ServiceName, Name: constants.HostDataUpdaterGroupName, Context: "type=SCS"}}
				req = context.SetUserRoles(req, roleInfo)
				req = context.SetTokenSubject(req, platformInfo.HwUUID)

				req.Header.Set("Content-Type", consts.HTTPMediaTypeJson)
				w = httptest.NewRecorder()
				router.ServeHTTP(w, req)
				Expect(w.Code).To(Equal(http.StatusOK))
			})

			It("Should return StatusInternalServerError - Failed to fetchPckCertInfo", func() {

				// to validate with cached data.
				platform := &types.Platform{
					QeID:     "1111111116973c5e69577195511e9080",
					PceID:    "1111",
					CPUSvn:   "1bf8deed6f929ce40bd658e61ea722eb",
					PceSvn:   "0a00",
					Encppid:  "00f51b4272163732be2101ee62dfdb175205a5179c5b5faff4b2ae103cb1150ef7d4e6041775543930600e41dd2e6aee7f40790f5a0380f6b29b1f1f7e6aad75bfa666153bb325c6db5b67f694d14bff98996c4994ce153278bfeb1b455dd4acbeacc97df6a3cd439a838218c1e07dae91a62195b803b9d3808d5b8470d46b0af3f275b6f6573871eb4eeb43ed9c5a5647729f25648fa74f1ce43621618b266abde6f44e92ce65bbbbe2c50e3e7a8b84d1ed38f53a1d99d3f15fc8c39b0ee568580c37a4eb19dbe87cd447c78f05544684701c01e64e0273dc69c27e46f732f7a7ee8cc4dfaf3b921bf6bbc3ee83f8de5f4e86039595cddaf7cadfce599f0eb92509ff2a90d189bda51fdd298fa1cffd4e8d79095f104c073a2b71cf61c727f4e5718cb7ea2f8fc6d7694bf3b40764234dfbe0d35f40f557545e1729ca639be4f1bcdc9028cb590b3ad3fd176bfea3cef13e57db057b3bae7ae8553a454515aecb21e4c58c670b19d8ee12668ab8af16d56b285153589eb85d15cd9e56fe459b",
					Fmspc:    "20606a000000",
					Ca:       "processor",
					Manifest: "178e874b49e44aa599bb3057170925b41d6e010000000000000000000000000084947ac684404189902a7e76cd658926bc010100000000000000000000000000e5db57cfd1af3e45ddfbd7f52e74a44871d542e3893c9f6f88ef999a7969eacc38e156d8233e6479997f6daa3553d902bb6a7fd6e6db21c43c13993c91c2eb95b6654b70d3e1602d5c236f9c5e8209a6a9923f49628eb7ba934913ccee4ae3df1c9ce11d0dac1c2e6ebbeb7b036e1288ad98d0aac44e5dbe3e01ea40eb7301c513c388d7e87b6630fcee23dccc28e5466a3669137e79021e386db75569606a481ac81bcd03fdc30a142bce8cca274dc044f2b40dc9abaef952bb4f0d01058d590d6950cd56bd036c7385272789e38de9b7302fafd5514248de83c18aedc9fb3c4a60754b41d8038be2c85d9e109742450b76989ff262cb0a7a979546018c7c76109ec6dd7965eead462bbd1edf6124e4a7da00de497408e44869496138cc1383f2caef7b6bf456c1f494c2b539e1741d904515414816a5096e96350b5decc84cdb9c29fe6ffa7a1982b55fe6fb258e18f03c1724b296aab446a9f4e10de1d49485f4360dfade7bc6abf70c0f1ed59c15ab30face19e3cfee43e1bee2f2800095576af52b46344ea4e7e08c2bc1d568dd01000100bcf7744b0929b513d15794280f82233b5684b73af7f86c073d1ecec86f6cd34c0000010001000000fd8f5c411b614b97a74796f08926757b39050100000000000000000000000000200000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
					HwUUID:   uuid.MustParse("ee37c360-7eae-4250-a677-6ee12adce8e2"),
				}

				db.PlatformRepository().Create(platform)

				PlatformInfoOps(router, db, conf, &client)

				platformInfo := PlatformInfo{
					EncPpid:  "00f51b4272163732be2101ee62dfdb175205a5179c5b5faff4b2ae103cb1150ef7d4e6041775543930600e41dd2e6aee7f40790f5a0380f6b29b1f1f7e6aad75bfa666153bb325c6db5b67f694d14bff98996c4994ce153278bfeb1b455dd4acbeacc97df6a3cd439a838218c1e07dae91a62195b803b9d3808d5b8470d46b0af3f275b6f6573871eb4eeb43ed9c5a5647729f25648fa74f1ce43621618b266abde6f44e92ce65bbbbe2c50e3e7a8b84d1ed38f53a1d99d3f15fc8c39b0ee568580c37a4eb19dbe87cd447c78f05544684701c01e64e0273dc69c27e46f732f7a7ee8cc4dfaf3b921bf6bbc3ee83f8de5f4e86039595cddaf7cadfce599f0eb92509ff2a90d189bda51fdd298fa1cffd4e8d79095f104c073a2b71cf61c727f4e5718cb7ea2f8fc6d7694bf3b40764234dfbe0d35f40f557545e1729ca639be4f1bcdc9028cb590b3ad3fd176bfea3cef13e57db057b3bae7ae8553a454515aecb21e4c58c670b19d8ee12668ab8af16d56b285153589eb85d15cd9e56fe459b",
					PceID:    "1111",
					CPUSvn:   "1bf8deed6f929ce40bd658e61ea722eb",
					PceSvn:   "0a00",
					QeID:     "1111111116973c5e69577195511e9080",
					Manifest: "178e874b49e44aa599bb3057170925b41d6e010000000000000000000000000084947ac684404189902a7e76cd658926bc010100000000000000000000000000e5db57cfd1af3e45ddfbd7f52e74a44871d542e3893c9f6f88ef999a7969eacc38e156d8233e6479997f6daa3553d902bb6a7fd6e6db21c43c13993c91c2eb95b6654b70d3e1602d5c236f9c5e8209a6a9923f49628eb7ba934913ccee4ae3df1c9ce11d0dac1c2e6ebbeb7b036e1288ad98d0aac44e5dbe3e01ea40eb7301c513c388d7e87b6630fcee23dccc28e5466a3669137e79021e386db75569606a481ac81bcd03fdc30a142bce8cca274dc044f2b40dc9abaef952bb4f0d01058d590d6950cd56bd036c7385272789e38de9b7302fafd5514248de83c18aedc9fb3c4a60754b41d8038be2c85d9e109742450b76989ff262cb0a7a979546018c7c76109ec6dd7965eead462bbd1edf6124e4a7da00de497408e44869496138cc1383f2caef7b6bf456c1f494c2b539e1741d904515414816a5096e96350b5decc84cdb9c29fe6ffa7a1982b55fe6fb258e18f03c1724b296aab446a9f4e10de1d49485f4360dfade7bc6abf70c0f1ed59c15ab30face19e3cfee43e1bee2f2800095576af52b46344ea4e7e08c2bc1d568dd01000100bcf7744b0929b513d15794280f82233b5684b73af7f86c073d1ecec86f6cd34c0000010001000000fd8f5c411b614b97a74796f08926757b39050100000000000000000000000000200000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
					HwUUID:   "ee37c360-7eae-4250-a677-6ee12adce8e2",
				}

				reqBody, _ := json.Marshal(platformInfo)
				req, err := http.NewRequest(http.MethodPost, "/platforms", bytes.NewReader(reqBody))
				Expect(err).NotTo(HaveOccurred())

				// valid permissions and userroles added.
				permissions := aas.PermissionInfo{Service: constants.ServiceName, Rules: []string{constants.HostDataUpdaterGroupName}}
				req = context.SetUserPermissions(req, []aas.PermissionInfo{permissions})
				roleInfo := []aas.RoleInfo{{Service: constants.ServiceName, Name: constants.HostDataUpdaterGroupName, Context: "type=SCS"}}
				req = context.SetUserRoles(req, roleInfo)
				req = context.SetTokenSubject(req, platformInfo.HwUUID)

				req.Header.Set("Content-Type", consts.HTTPMediaTypeJson)
				w = httptest.NewRecorder()
				router.ServeHTTP(w, req)
				Expect(w.Code).To(Equal(http.StatusInternalServerError))
			})

			It("Should return StatusBadRequest - Invalid body content given", func() {

				PlatformInfoOps(router, db, conf, &client)

				// Invalid req body
				reqBody := []byte(`{"enc_ppid":"00f51b4272163732be2101ee62dfdb175205a5179c5b5faff4b2ae103cb1150ef7d4e6041775543930600e41dd2e6aee7f40790f5a0380f6b29b1f1f7e6aad75bfa666153bb325c6db5b67f694d14b`)
				req, err := http.NewRequest(http.MethodPost, "/platforms", bytes.NewReader(reqBody))
				Expect(err).NotTo(HaveOccurred())

				// valid permissions and userroles added.
				permissions := aas.PermissionInfo{Service: constants.ServiceName, Rules: []string{constants.HostDataUpdaterGroupName}}
				req = context.SetUserPermissions(req, []aas.PermissionInfo{permissions})
				roleInfo := []aas.RoleInfo{{Service: constants.ServiceName, Name: constants.HostDataUpdaterGroupName, Context: "type=SCS"}}
				req = context.SetUserRoles(req, roleInfo)

				req.Header.Set("Content-Type", consts.HTTPMediaTypeJson)
				w = httptest.NewRecorder()
				router.ServeHTTP(w, req)
				Expect(w.Code).To(Equal(http.StatusBadRequest))
			})

			It("Should return StatusBadRequest - Invalid values given", func() {

				PlatformInfoOps(router, db, conf, &client)

				platformInfo := PlatformInfo{
					EncPpid:  "00f51b42721_63732be2101ee62dfdb175205a5179c5b5faff4b2ae103cb1150ef7d4e6041775543930600e41dd2e6aee7f40790f5a0380f6b29b1f1f7e6aad75bfa666153bb325c6db5b67f694d14bff98996c4994ce153278bfeb1b455dd4acbeacc97df6a3cd439a838218c1e07dae91a62195b803b9d3808d5b8470d46b0af3f275b6f6573871eb4eeb43ed9c5a5647729f25648fa74f1ce43621618b266abde6f44e92ce65bbbbe2c50e3e7a8b84d1ed38f53a1d99d3f15fc8c39b0ee568580c37a4eb19dbe87cd447c78f05544684701c01e64e0273dc69c27e46f732f7a7ee8cc4dfaf3b921bf6bbc3ee83f8de5f4e86039595cddaf7cadfce599f0eb92509ff2a90d189bda51fdd298fa1cffd4e8d79095f104c073a2b71cf61c727f4e5718cb7ea2f8fc6d7694bf3b40764234dfbe0d35f40f557545e1729ca639be4f1bcdc9028cb590b3ad3fd176bfea3cef13e57db057b3bae7ae8553a454515aecb21e4c58c670b19d8ee12668ab8af16d56b285153589eb85d15cd9e56fe459b",
					PceID:    "0000",
					CPUSvn:   "1bf8dee_d6f929ce40bd658e61ea722eb",
					PceSvn:   "0a00",
					QeID:     "051814549_6973c5e69577195511e9080",
					Manifest: "178e874b49e44aa599bb3057170925b41d6e010000000000000000000000000084947ac684404189902a7e76cd658926bc010100000000000000000000000000e5db57cfd1af3e45ddfbd7f52e74a44871d542e3893c9f6f88ef999a7969eacc38e156d8233e6479997f6daa3553d902bb6a7fd6e6db21c43c13993c91c2eb95b6654b70d3e1602d5c236f9c5e8209a6a9923f49628eb7ba934913ccee4ae3df1c9ce11d0dac1c2e6ebbeb7b036e1288ad98d0aac44e5dbe3e01ea40eb7301c513c388d7e87b6630fcee23dccc28e5466a3669137e79021e386db75569606a481ac81bcd03fdc30a142bce8cca274dc044f2b40dc9abaef952bb4f0d01058d590d6950cd56bd036c7385272789e38de9b7302fafd5514248de83c18aedc9fb3c4a60754b41d8038be2c85d9e109742450b76989ff262cb0a7a979546018c7c76109ec6dd7965eead462bbd1edf6124e4a7da00de497408e44869496138cc1383f2caef7b6bf456c1f494c2b539e1741d904515414816a5096e96350b5decc84cdb9c29fe6ffa7a1982b55fe6fb258e18f03c1724b296aab446a9f4e10de1d49485f4360dfade7bc6abf70c0f1ed59c15ab30face19e3cfee43e1bee2f2800095576af52b46344ea4e7e08c2bc1d568dd01000100bcf7744b0929b513d15794280f82233b5684b73af7f86c073d1ecec86f6cd34c0000010001000000fd8f5c411b614b97a74796f08926757b39050100000000000000000000000000200000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
					HwUUID:   "ee37c360-7eae-4250-a677-6ee12adce8e2",
				}

				reqBody, _ := json.Marshal(platformInfo)
				req, err := http.NewRequest(http.MethodPost, "/platforms", bytes.NewReader(reqBody))
				Expect(err).NotTo(HaveOccurred())

				// valid permissions and userroles added.
				permissions := aas.PermissionInfo{Service: constants.ServiceName, Rules: []string{constants.HostDataUpdaterGroupName}}
				req = context.SetUserPermissions(req, []aas.PermissionInfo{permissions})
				roleInfo := []aas.RoleInfo{{Service: constants.ServiceName, Name: constants.HostDataUpdaterGroupName, Context: "type=SCS"}}
				req = context.SetUserRoles(req, roleInfo)
				req = context.SetTokenSubject(req, platformInfo.HwUUID)

				req.Header.Set("Content-Type", consts.HTTPMediaTypeJson)
				w = httptest.NewRecorder()
				router.ServeHTTP(w, req)
				Expect(w.Code).To(Equal(http.StatusBadRequest))
			})

			It("Should return StatusUnauthorized - Invalid Token given", func() {

				PlatformInfoOps(router, db, conf, &client)

				platformInfo := PlatformInfo{
					EncPpid:  "00f51b4272163732be2101ee62dfdb175205a5179c5b5faff4b2ae103cb1150ef7d4e6041775543930600e41dd2e6aee7f40790f5a0380f6b29b1f1f7e6aad75bfa666153bb325c6db5b67f694d14bff98996c4994ce153278bfeb1b455dd4acbeacc97df6a3cd439a838218c1e07dae91a62195b803b9d3808d5b8470d46b0af3f275b6f6573871eb4eeb43ed9c5a5647729f25648fa74f1ce43621618b266abde6f44e92ce65bbbbe2c50e3e7a8b84d1ed38f53a1d99d3f15fc8c39b0ee568580c37a4eb19dbe87cd447c78f05544684701c01e64e0273dc69c27e46f732f7a7ee8cc4dfaf3b921bf6bbc3ee83f8de5f4e86039595cddaf7cadfce599f0eb92509ff2a90d189bda51fdd298fa1cffd4e8d79095f104c073a2b71cf61c727f4e5718cb7ea2f8fc6d7694bf3b40764234dfbe0d35f40f557545e1729ca639be4f1bcdc9028cb590b3ad3fd176bfea3cef13e57db057b3bae7ae8553a454515aecb21e4c58c670b19d8ee12668ab8af16d56b285153589eb85d15cd9e56fe459b",
					PceID:    "0000",
					CPUSvn:   "1bf8deed6f929ce40bd658e61ea722eb",
					PceSvn:   "0a00",
					QeID:     "0518145496973c5e69577195511e9080",
					Manifest: "178e874b49e44aa599bb3057170925b41d6e010000000000000000000000000084947ac684404189902a7e76cd658926bc010100000000000000000000000000e5db57cfd1af3e45ddfbd7f52e74a44871d542e3893c9f6f88ef999a7969eacc38e156d8233e6479997f6daa3553d902bb6a7fd6e6db21c43c13993c91c2eb95b6654b70d3e1602d5c236f9c5e8209a6a9923f49628eb7ba934913ccee4ae3df1c9ce11d0dac1c2e6ebbeb7b036e1288ad98d0aac44e5dbe3e01ea40eb7301c513c388d7e87b6630fcee23dccc28e5466a3669137e79021e386db75569606a481ac81bcd03fdc30a142bce8cca274dc044f2b40dc9abaef952bb4f0d01058d590d6950cd56bd036c7385272789e38de9b7302fafd5514248de83c18aedc9fb3c4a60754b41d8038be2c85d9e109742450b76989ff262cb0a7a979546018c7c76109ec6dd7965eead462bbd1edf6124e4a7da00de497408e44869496138cc1383f2caef7b6bf456c1f494c2b539e1741d904515414816a5096e96350b5decc84cdb9c29fe6ffa7a1982b55fe6fb258e18f03c1724b296aab446a9f4e10de1d49485f4360dfade7bc6abf70c0f1ed59c15ab30face19e3cfee43e1bee2f2800095576af52b46344ea4e7e08c2bc1d568dd01000100bcf7744b0929b513d15794280f82233b5684b73af7f86c073d1ecec86f6cd34c0000010001000000fd8f5c411b614b97a74796f08926757b39050100000000000000000000000000200000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
					HwUUID:   "ee37c360-7eae-4250-a677-6ee12adce8e2",
				}

				reqBody, _ := json.Marshal(platformInfo)
				req, err := http.NewRequest(http.MethodPost, "/platforms", bytes.NewReader(reqBody))
				Expect(err).NotTo(HaveOccurred())

				// valid permissions and userroles added.
				permissions := aas.PermissionInfo{Service: constants.ServiceName, Rules: []string{constants.HostDataUpdaterGroupName}}
				req = context.SetUserPermissions(req, []aas.PermissionInfo{permissions})
				roleInfo := []aas.RoleInfo{{Service: constants.ServiceName, Name: constants.HostDataUpdaterGroupName, Context: "type=SCS"}}
				req = context.SetUserRoles(req, roleInfo)
				req = context.SetTokenSubject(req, "ee37c360-7eae-4250-b777-6ee12adce8e2")

				req.Header.Set("Content-Type", consts.HTTPMediaTypeJson)
				w = httptest.NewRecorder()
				router.ServeHTTP(w, req)
				Expect(w.Code).To(Equal(http.StatusUnauthorized))
			})

		})
	})
})

var _ = Describe("TcbInfo Validation", func() {
	var router *mux.Router
	var w *httptest.ResponseRecorder
	var db repository.SCSDatabase
	var conf *config.Configuration
	var client domain.HttpClient

	db = getMockDatabase()
	conf = config.Load(testConfigFilePath)
	client = mocks.NewClientMock(200)

	BeforeEach(func() {
		router = mux.NewRouter()
	})

	Describe("Tcbstatus Resource validation", func() {
		Context("tcbstatus request validation", func() {

			It("Should return StatusBadRequest - Insufficient roles", func() {

				PlatformInfoOps(router, db, nil, nil)

				req, err := http.NewRequest(http.MethodGet, "/tcbstatus", nil)
				Expect(err).NotTo(HaveOccurred())

				// valid permissions added insufficient roles.
				permissions := aas.PermissionInfo{Service: constants.ServiceName, Rules: []string{constants.HostDataUpdaterGroupName}}
				req = context.SetUserPermissions(req, []aas.PermissionInfo{permissions})
				req.Header.Set("Content-Type", consts.HTTPMediaTypeJson)
				w = httptest.NewRecorder()
				router.ServeHTTP(w, req)
				Expect(w.Code).To(Equal(http.StatusInternalServerError))
			})

			It("Should return StatusBadRequest - No URL query given", func() {

				PlatformInfoOps(router, db, conf, nil)

				req, err := http.NewRequest(http.MethodGet, "/tcbstatus", nil)
				Expect(err).NotTo(HaveOccurred())

				// valid permissions and userroles added.
				permissions := aas.PermissionInfo{Service: constants.ServiceName, Rules: []string{constants.HostDataReaderGroupName}}
				req = context.SetUserPermissions(req, []aas.PermissionInfo{permissions})
				roleInfo := []aas.RoleInfo{{Service: constants.ServiceName, Name: constants.HostDataReaderGroupName, Context: "type=SCS"}}
				req = context.SetUserRoles(req, roleInfo)
				req.Header.Set("Content-Type", consts.HTTPMediaTypeJson)
				w = httptest.NewRecorder()
				router.ServeHTTP(w, req)
				Expect(w.Code).To(Equal(http.StatusBadRequest))
			})

			It("Should return StatusBadRequest - Invalid URL query given", func() {

				PlatformInfoOps(router, db, conf, nil)

				req, err := http.NewRequest(http.MethodGet, "/tcbstatus?test=testName&test1=testName", nil)
				Expect(err).NotTo(HaveOccurred())

				// valid permissions and userroles added.
				permissions := aas.PermissionInfo{Service: constants.ServiceName, Rules: []string{constants.HostDataReaderGroupName}}
				req = context.SetUserPermissions(req, []aas.PermissionInfo{permissions})
				roleInfo := []aas.RoleInfo{{Service: constants.ServiceName, Name: constants.HostDataReaderGroupName, Context: "type=SCS"}}
				req = context.SetUserRoles(req, roleInfo)
				req.Header.Set("Content-Type", consts.HTTPMediaTypeJson)
				w = httptest.NewRecorder()
				router.ServeHTTP(w, req)
				Expect(w.Code).To(Equal(http.StatusBadRequest))
			})

			It("Should return StatusBadRequest - Empty query value given", func() {

				PlatformInfoOps(router, db, conf, nil)

				req, err := http.NewRequest(http.MethodGet, "/tcbstatus?qeid&pceid", nil)
				Expect(err).NotTo(HaveOccurred())

				// valid permissions and userroles added.
				permissions := aas.PermissionInfo{Service: constants.ServiceName, Rules: []string{constants.HostDataReaderGroupName}}
				req = context.SetUserPermissions(req, []aas.PermissionInfo{permissions})
				roleInfo := []aas.RoleInfo{{Service: constants.ServiceName, Name: constants.HostDataReaderGroupName, Context: "type=SCS"}}
				req = context.SetUserRoles(req, roleInfo)
				req.Header.Set("Content-Type", consts.HTTPMediaTypeJson)
				w = httptest.NewRecorder()
				router.ServeHTTP(w, req)
				Expect(w.Code).To(Equal(http.StatusBadRequest))
			})

			It("Should return StatusNotFound - Unknown qeid and pceid value given", func() {

				PlatformInfoOps(router, db, conf, nil)

				req, err := http.NewRequest(http.MethodGet, "/tcbstatus?pceid=1000&qeid=1518145496973c5e69577195511e9080", nil)
				Expect(err).NotTo(HaveOccurred())

				// valid permissions and userroles added.
				permissions := aas.PermissionInfo{Service: constants.ServiceName, Rules: []string{constants.HostDataReaderGroupName}}
				req = context.SetUserPermissions(req, []aas.PermissionInfo{permissions})
				roleInfo := []aas.RoleInfo{{Service: constants.ServiceName, Name: constants.HostDataReaderGroupName, Context: "type=SCS"}}
				req = context.SetUserRoles(req, roleInfo)
				req.Header.Set("Content-Type", consts.HTTPMediaTypeJson)
				w = httptest.NewRecorder()
				router.ServeHTTP(w, req)
				Expect(w.Code).To(Equal(http.StatusNotFound))
			})

			It("Should return StatusOK - Valid query given", func() {

				newPckCert := &types.PckCert{
					QeID:      "0518145496973c5e69577195511e9080",
					PceID:     "0000",
					CertIndex: 0,
					Tcbms:     []string{"030300000000000000000000000000000A00"},
					Fmspc:     "20606a000000",
				}
				db.PckCertRepository().Create(newPckCert)

				platform := &types.Platform{
					QeID:     "0518145496973c5e69577195511e9080",
					PceID:    "0000",
					CPUSvn:   "1bf8deed6f929ce40bd658e61ea722eb",
					PceSvn:   "0a00",
					Encppid:  "00f51b4272163732be2101ee62dfdb175205a5179c5b5faff4b2ae103cb1150ef7d4e6041775543930600e41dd2e6aee7f40790f5a0380f6b29b1f1f7e6aad75bfa666153bb325c6db5b67f694d14bff98996c4994ce153278bfeb1b455dd4acbeacc97df6a3cd439a838218c1e07dae91a62195b803b9d3808d5b8470d46b0af3f275b6f6573871eb4eeb43ed9c5a5647729f25648fa74f1ce43621618b266abde6f44e92ce65bbbbe2c50e3e7a8b84d1ed38f53a1d99d3f15fc8c39b0ee568580c37a4eb19dbe87cd447c78f05544684701c01e64e0273dc69c27e46f732f7a7ee8cc4dfaf3b921bf6bbc3ee83f8de5f4e86039595cddaf7cadfce599f0eb92509ff2a90d189bda51fdd298fa1cffd4e8d79095f104c073a2b71cf61c727f4e5718cb7ea2f8fc6d7694bf3b40764234dfbe0d35f40f557545e1729ca639be4f1bcdc9028cb590b3ad3fd176bfea3cef13e57db057b3bae7ae8553a454515aecb21e4c58c670b19d8ee12668ab8af16d56b285153589eb85d15cd9e56fe459b",
					Fmspc:    "20606a000000",
					Ca:       "p.Ca",
					Manifest: "178e874b49e44aa599bb3057170925b41d6e010000000000000000000000000084947ac684404189902a7e76cd658926bc010100000000000000000000000000e5db57cfd1af3e45ddfbd7f52e74a44871d542e3893c9f6f88ef999a7969eacc38e156d8233e6479997f6daa3553d902bb6a7fd6e6db21c43c13993c91c2eb95b6654b70d3e1602d5c236f9c5e8209a6a9923f49628eb7ba934913ccee4ae3df1c9ce11d0dac1c2e6ebbeb7b036e1288ad98d0aac44e5dbe3e01ea40eb7301c513c388d7e87b6630fcee23dccc28e5466a3669137e79021e386db75569606a481ac81bcd03fdc30a142bce8cca274dc044f2b40dc9abaef952bb4f0d01058d590d6950cd56bd036c7385272789e38de9b7302fafd5514248de83c18aedc9fb3c4a60754b41d8038be2c85d9e109742450b76989ff262cb0a7a979546018c7c76109ec6dd7965eead462bbd1edf6124e4a7da00de497408e44869496138cc1383f2caef7b6bf456c1f494c2b539e1741d904515414816a5096e96350b5decc84cdb9c29fe6ffa7a1982b55fe6fb258e18f03c1724b296aab446a9f4e10de1d49485f4360dfade7bc6abf70c0f1ed59c15ab30face19e3cfee43e1bee2f2800095576af52b46344ea4e7e08c2bc1d568dd01000100bcf7744b0929b513d15794280f82233b5684b73af7f86c073d1ecec86f6cd34c0000010001000000fd8f5c411b614b97a74796f08926757b39050100000000000000000000000000200000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
					HwUUID:   uuid.MustParse("ee37c360-7eae-4250-a677-6ee12adce8e2"),
				}

				db.PlatformRepository().Create(platform)

				var tcbInfoJson TcbInfoJSON

				json.Unmarshal(testTcbInfoJson, &tcbInfoJson)

				tcbInfo := &types.FmspcTcbInfo{
					Fmspc:   "20606a000000",
					TcbInfo: string(testTcbInfoJson),
				}
				db.FmspcTcbInfoRepository().Create(tcbInfo)

				PlatformInfoOps(router, db, conf, &client)

				req, err := http.NewRequest(http.MethodGet, "/tcbstatus?pceid=0000&qeid=0518145496973c5e69577195511e9080", nil)
				Expect(err).NotTo(HaveOccurred())

				// valid permissions and userroles added.
				permissions := aas.PermissionInfo{Service: constants.ServiceName, Rules: []string{constants.HostDataReaderGroupName}}
				req = context.SetUserPermissions(req, []aas.PermissionInfo{permissions})
				roleInfo := []aas.RoleInfo{{Service: constants.ServiceName, Name: constants.HostDataReaderGroupName, Context: "type=SCS"}}
				req = context.SetUserRoles(req, roleInfo)

				req.Header.Set("Content-Type", consts.HTTPMediaTypeJson)
				w = httptest.NewRecorder()
				router.ServeHTTP(w, req)
				Expect(w.Code).To(Equal(http.StatusOK))
			})
		})
	})
})

// RefreshPlatformInfoOps Resource validation
var _ = Describe("RefreshPlatformInfoOps Validation", func() {
	var router *mux.Router
	var w *httptest.ResponseRecorder

	db := getMockDatabase()

	BeforeEach(func() {
		router = mux.NewRouter()
	})

	Describe("RefreshPlatformInfoOps Resource validation", func() {
		Context("GET refreshPlatformInfoStatus request validation", func() {

			It("Should return StatusBadRequest - Insufficient roles", func() {

				RefreshPlatformInfoOps(router, db, nil)

				req, err := http.NewRequest(http.MethodGet, "/refreshes", nil)
				Expect(err).NotTo(HaveOccurred())

				// Invalid permission
				permissions := aas.PermissionInfo{Service: constants.ServiceName, Rules: []string{constants.HostDataUpdaterGroupName}}
				req = context.SetUserPermissions(req, []aas.PermissionInfo{permissions})
				req.Header.Set("Content-Type", consts.HTTPMediaTypeJson)
				w = httptest.NewRecorder()
				router.ServeHTTP(w, req)
				Expect(w.Code).To(Equal(http.StatusInternalServerError))
			})

			It("Should return StatusBadRequest - Insufficient roles", func() {

				RefreshPlatformInfoOps(router, db, nil)

				req, err := http.NewRequest(http.MethodGet, "/refreshes", nil)
				Expect(err).NotTo(HaveOccurred())

				// valid permissions added and insufficient roles.
				permissions := aas.PermissionInfo{Service: constants.ServiceName, Rules: []string{constants.CacheManagerGroupName}}
				req = context.SetUserPermissions(req, []aas.PermissionInfo{permissions})
				req.Header.Set("Content-Type", consts.HTTPMediaTypeJson)
				w = httptest.NewRecorder()
				router.ServeHTTP(w, req)
				Expect(w.Code).To(Equal(http.StatusInternalServerError))
			})

			It("Should return StatusBadRequest - Insufficient roles", func() {

				RefreshPlatformInfoOps(router, db, nil)

				req, err := http.NewRequest(http.MethodGet, "/refreshes", nil)
				Expect(err).NotTo(HaveOccurred())

				// valid permissions and roles added.
				permissions := aas.PermissionInfo{Service: constants.ServiceName, Rules: []string{constants.CacheManagerGroupName}}
				req = context.SetUserPermissions(req, []aas.PermissionInfo{permissions})
				roleInfo := []aas.RoleInfo{{Service: constants.ServiceName, Name: constants.CacheManagerGroupName, Context: "type=SCS"}}
				req = context.SetUserRoles(req, roleInfo)

				req.Header.Set("Content-Type", consts.HTTPMediaTypeJson)
				w = httptest.NewRecorder()
				router.ServeHTTP(w, req)
				Expect(w.Code).To(Equal(http.StatusOK))
			})
		})
	})
})

var _ = Describe("RefreshPlatformInfoOps Validation", func() {
	var router *mux.Router
	var w *httptest.ResponseRecorder
	db := getMockDatabase()

	BeforeEach(func() {
		router = mux.NewRouter()
	})

	Describe("refreshPlatformInfoStart Resource validation", func() {
		Context("POST refreshPlatformInfoStart request validation", func() {

			It("Should return StatusInternalServerError - Invalid permission given", func() {

				RefreshPlatformInfoOps(router, db, nil)

				req, err := http.NewRequest(http.MethodPost, "/refreshes", nil)
				Expect(err).NotTo(HaveOccurred())

				// invalid permissions given.
				permissions := aas.PermissionInfo{Service: constants.ServiceName, Rules: []string{constants.HostDataUpdaterGroupName}}
				req = context.SetUserPermissions(req, []aas.PermissionInfo{permissions})
				req.Header.Set("Content-Type", consts.HTTPMediaTypeJson)
				w = httptest.NewRecorder()
				router.ServeHTTP(w, req)
				Expect(w.Code).To(Equal(http.StatusInternalServerError))
			})

			It("Should return StatusInternalServerError - valid permissions and insufficient roles given.", func() {

				RefreshPlatformInfoOps(router, db, nil)

				req, err := http.NewRequest(http.MethodPost, "/refreshes", nil)
				Expect(err).NotTo(HaveOccurred())

				// valid permissions and insufficient roles given.
				permissions := aas.PermissionInfo{Service: constants.ServiceName, Rules: []string{constants.CacheManagerGroupName}}
				req = context.SetUserPermissions(req, []aas.PermissionInfo{permissions})
				req.Header.Set("Content-Type", consts.HTTPMediaTypeJson)
				w = httptest.NewRecorder()
				router.ServeHTTP(w, req)
				Expect(w.Code).To(Equal(http.StatusInternalServerError))
			})

			It("Should return StatusOK - Valid Request", func() {

				RefreshPlatformInfoOps(router, db, nil)

				req, err := http.NewRequest(http.MethodPost, "/refreshes", nil)
				Expect(err).NotTo(HaveOccurred())

				// valid permissions and roles added.
				permissions := aas.PermissionInfo{Service: constants.ServiceName, Rules: []string{constants.CacheManagerGroupName}}
				req = context.SetUserPermissions(req, []aas.PermissionInfo{permissions})
				roleInfo := []aas.RoleInfo{{Service: constants.ServiceName, Name: constants.CacheManagerGroupName, Context: "type=SCS"}}
				req = context.SetUserRoles(req, roleInfo)

				req.Header.Set("Content-Type", consts.HTTPMediaTypeJson)
				w = httptest.NewRecorder()
				router.ServeHTTP(w, req)
				Expect(w.Code).To(Equal(http.StatusOK))
			})

		})
	})
})

func TestCachePckCertInfo(t *testing.T) {
	db := getMockDatabase()

	newPckCert := &types.PckCert{
		QeID:      "0518145496973c5e69577195511e9080",
		PceID:     "0000",
		CertIndex: 0,
		Tcbms:     []string{"030300000000000000000000000000000A00"},
		Fmspc:     "20606a000000",
		PckCerts:  []string{"-----BEGIN%20CERTIFICATE-----%0AMIIE9DCCBJqgAwIBAgIUb6rZwuxZc5cIkp6%2Foqqz7HdGyFwwCgYIKoZIzj0EAwIw%0AcDEiMCAGA1UEAwwZSW50ZWwgU0dYIFBDSyBQbGF0Zm9ybSBDQTEaMBgGA1UECgwR%0ASW50ZWwgQ29ycG9yYXRpb24xFDASBgNVBAcMC1NhbnRhIENsYXJhMQswCQYDVQQI%0ADAJDQTELMAkGA1UEBhMCVVMwHhcNMjIwNjIxMTEyNDU2WhcNMjkwNjIxMTEyNDU2%0AWjBwMSIwIAYDVQQDDBlJbnRlbCBTR1ggUENLIENlcnRpZmljYXRlMRowGAYDVQQK%0ADBFJbnRlbCBDb3Jwb3JhdGlvbjEUMBIGA1UEBwwLU2FudGEgQ2xhcmExCzAJBgNV%0ABAgMAkNBMQswCQYDVQQGEwJVUzBZMBMGByqGSM49AgEGCCqGSM49AwEHA0IABOB3%0AWFm1ziJAlu79StgxfAuz8AWCkoiraneuAGgrFExeiukczJvjWdtDTM2O7w8GiZAt%0A1h84AyDRUb%2BHoNaflACjggMQMIIDDDAfBgNVHSMEGDAWgBRZI9OnSqhjVC45cK3g%0ADwcrVyQqtzBvBgNVHR8EaDBmMGSgYqBghl5odHRwczovL3NieC5hcGkudHJ1c3Rl%0AZHNlcnZpY2VzLmludGVsLmNvbS9zZ3gvY2VydGlmaWNhdGlvbi92My9wY2tjcmw%2F%0AY2E9cGxhdGZvcm0mZW5jb2Rpbmc9ZGVyMB0GA1UdDgQWBBQ6mE6WHjgoVSRiUaG%2F%0A0QmQDpX7LjAOBgNVHQ8BAf8EBAMCBsAwDAYDVR0TAQH%2FBAIwADCCAjkGCSqGSIb4%0ATQENAQSCAiowggImMB4GCiqGSIb4TQENAQEEEGzzoSC5Btq3aBE%2BWYxHhwUwggFj%0ABgoqhkiG%2BE0BDQECMIIBUzAQBgsqhkiG%2BE0BDQECAQIBATAQBgsqhkiG%2BE0BDQEC%0AAgIBATAQBgsqhkiG%2BE0BDQECAwIBADAQBgsqhkiG%2BE0BDQECBAIBADAQBgsqhkiG%0A%2BE0BDQECBQIBADAQBgsqhkiG%2BE0BDQECBgIBADAQBgsqhkiG%2BE0BDQECBwIBADAQ%0ABgsqhkiG%2BE0BDQECCAIBADAQBgsqhkiG%2BE0BDQECCQIBADAQBgsqhkiG%2BE0BDQEC%0ACgIBADAQBgsqhkiG%2BE0BDQECCwIBADAQBgsqhkiG%2BE0BDQECDAIBADAQBgsqhkiG%0A%2BE0BDQECDQIBADAQBgsqhkiG%2BE0BDQECDgIBADAQBgsqhkiG%2BE0BDQECDwIBADAQ%0ABgsqhkiG%2BE0BDQECEAIBADAQBgsqhkiG%2BE0BDQECEQIBCTAfBgsqhkiG%2BE0BDQEC%0AEgQQAQEAAAAAAAAAAAAAAAAAADAQBgoqhkiG%2BE0BDQEDBAIAADAUBgoqhkiG%2BE0B%0ADQEEBAYQYGoAAAAwDwYKKoZIhvhNAQ0BBQoBATAeBgoqhkiG%2BE0BDQEGBBDjJ4f6%0AieS5MJrtZWT28t9KMEQGCiqGSIb4TQENAQcwNjAQBgsqhkiG%2BE0BDQEHAQEB%2FzAQ%0ABgsqhkiG%2BE0BDQEHAgEBADAQBgsqhkiG%2BE0BDQEHAwEB%2FzAKBggqhkjOPQQDAgNI%0AADBFAiBJwRZ5Dkvmz41SMH%2FFojZqiPxfzpQo78iqcvTdo0DwTQIhAPzZkuFcwZUV%0Al0yBja8lgLWp%2F8eMKpx5hOAw1dDV2iST%0A-----END%20CERTIFICATE-----%0A"},
	}

	_, err := cachePckCertInfo(db, newPckCert, constants.CacheRefresh)
	assert.Nil(t, err)

	// Cache Type Insert
	_, err = cachePckCertInfo(db, newPckCert, constants.CacheInsert)
	assert.Nil(t, err)

	// negative scenario
	newPckCert.QeID = ""
	newPckCert.PceID = ""
	_, err = cachePckCertInfo(db, newPckCert, constants.CacheRefresh)
	assert.NotNil(t, err)

	newPckCert.QeID = "0518145496973c5e69577195511e9080"
	newPckCert.PceID = "0000"
	db.PckCertRepository().Create(newPckCert)
	// create existing cert
	_, err = cachePckCertInfo(db, newPckCert, constants.CacheInsert)
	assert.NotNil(t, err)

}

func TestCachePckCertChainInfo(t *testing.T) {

	db := getMockDatabase()

	certChain := &types.PckCertChain{
		Ca:           "processor",
		PckCertChain: "-----BEGIN%20CERTIFICATE-----%0AMIIE9DCCBJqgAwIBAgIUb6rZwuxZc5cIkp6%2Foqqz7HdGyFwwCgYIKoZIzj0EAwIw%0AcDEiMCAGA1UEAwwZSW50ZWwgU0dYIFBDSyBQbGF0Zm9ybSBDQTEaMBgGA1UECgwR%0ASW50ZWwgQ29ycG9yYXRpb24xFDASBgNVBAcMC1NhbnRhIENsYXJhMQswCQYDVQQI%0ADAJDQTELMAkGA1UEBhMCVVMwHhcNMjIwNjIxMTEyNDU2WhcNMjkwNjIxMTEyNDU2%0AWjBwMSIwIAYDVQQDDBlJbnRlbCBTR1ggUENLIENlcnRpZmljYXRlMRowGAYDVQQK%0ADBFJbnRlbCBDb3Jwb3JhdGlvbjEUMBIGA1UEBwwLU2FudGEgQ2xhcmExCzAJBgNV%0ABAgMAkNBMQswCQYDVQQGEwJVUzBZMBMGByqGSM49AgEGCCqGSM49AwEHA0IABOB3%0AWFm1ziJAlu79StgxfAuz8AWCkoiraneuAGgrFExeiukczJvjWdtDTM2O7w8GiZAt%0A1h84AyDRUb%2BHoNaflACjggMQMIIDDDAfBgNVHSMEGDAWgBRZI9OnSqhjVC45cK3g%0ADwcrVyQqtzBvBgNVHR8EaDBmMGSgYqBghl5odHRwczovL3NieC5hcGkudHJ1c3Rl%0AZHNlcnZpY2VzLmludGVsLmNvbS9zZ3gvY2VydGlmaWNhdGlvbi92My9wY2tjcmw%2F%0AY2E9cGxhdGZvcm0mZW5jb2Rpbmc9ZGVyMB0GA1UdDgQWBBQ6mE6WHjgoVSRiUaG%2F%0A0QmQDpX7LjAOBgNVHQ8BAf8EBAMCBsAwDAYDVR0TAQH%2FBAIwADCCAjkGCSqGSIb4%0ATQENAQSCAiowggImMB4GCiqGSIb4TQENAQEEEGzzoSC5Btq3aBE%2BWYxHhwUwggFj%0ABgoqhkiG%2BE0BDQECMIIBUzAQBgsqhkiG%2BE0BDQECAQIBATAQBgsqhkiG%2BE0BDQEC%0AAgIBATAQBgsqhkiG%2BE0BDQECAwIBADAQBgsqhkiG%2BE0BDQECBAIBADAQBgsqhkiG%0A%2BE0BDQECBQIBADAQBgsqhkiG%2BE0BDQECBgIBADAQBgsqhkiG%2BE0BDQECBwIBADAQ%0ABgsqhkiG%2BE0BDQECCAIBADAQBgsqhkiG%2BE0BDQECCQIBADAQBgsqhkiG%2BE0BDQEC%0ACgIBADAQBgsqhkiG%2BE0BDQECCwIBADAQBgsqhkiG%2BE0BDQECDAIBADAQBgsqhkiG%0A%2BE0BDQECDQIBADAQBgsqhkiG%2BE0BDQECDgIBADAQBgsqhkiG%2BE0BDQECDwIBADAQ%0ABgsqhkiG%2BE0BDQECEAIBADAQBgsqhkiG%2BE0BDQECEQIBCTAfBgsqhkiG%2BE0BDQEC%0AEgQQAQEAAAAAAAAAAAAAAAAAADAQBgoqhkiG%2BE0BDQEDBAIAADAUBgoqhkiG%2BE0B%0ADQEEBAYQYGoAAAAwDwYKKoZIhvhNAQ0BBQoBATAeBgoqhkiG%2BE0BDQEGBBDjJ4f6%0AieS5MJrtZWT28t9KMEQGCiqGSIb4TQENAQcwNjAQBgsqhkiG%2BE0BDQEHAQEB%2FzAQ%0ABgsqhkiG%2BE0BDQEHAgEBADAQBgsqhkiG%2BE0BDQEHAwEB%2FzAKBggqhkjOPQQDAgNI%0AADBFAiBJwRZ5Dkvmz41SMH%2FFojZqiPxfzpQo78iqcvTdo0DwTQIhAPzZkuFcwZUV%0Al0yBja8lgLWp%2F8eMKpx5hOAw1dDV2iST%0A-----END%20CERTIFICATE-----%0A",
	}

	_, err := cachePckCertChainInfo(db, certChain.PckCertChain, certChain.Ca, constants.CacheRefresh)
	assert.Nil(t, err)

	// cache type insert
	_, err = cachePckCertChainInfo(db, certChain.PckCertChain, certChain.Ca, constants.CacheInsert)
	assert.Nil(t, err)

	// negative tests
	_, err = cachePckCertChainInfo(db, "", "", constants.CacheRefresh)
	assert.NotNil(t, err)

	db.PckCertChainRepository().Create(certChain)
	// create exisiting one
	// cache type insert
	_, err = cachePckCertChainInfo(db, certChain.PckCertChain, certChain.Ca, constants.CacheInsert)
	assert.NotNil(t, err)
}

func TestCachePlatformInfo(t *testing.T) {
	db := getMockDatabase()

	platform := &types.Platform{
		QeID:     "0518145496973c5e69577195511e9080",
		PceID:    "0000",
		CPUSvn:   "1bf8deed6f929ce40bd658e61ea722eb",
		PceSvn:   "0a00",
		Encppid:  "00f51b4272163732be2101ee62dfdb175205a5179c5b5faff4b2ae103cb1150ef7d4e6041775543930600e41dd2e6aee7f40790f5a0380f6b29b1f1f7e6aad75bfa666153bb325c6db5b67f694d14bff98996c4994ce153278bfeb1b455dd4acbeacc97df6a3cd439a838218c1e07dae91a62195b803b9d3808d5b8470d46b0af3f275b6f6573871eb4eeb43ed9c5a5647729f25648fa74f1ce43621618b266abde6f44e92ce65bbbbe2c50e3e7a8b84d1ed38f53a1d99d3f15fc8c39b0ee568580c37a4eb19dbe87cd447c78f05544684701c01e64e0273dc69c27e46f732f7a7ee8cc4dfaf3b921bf6bbc3ee83f8de5f4e86039595cddaf7cadfce599f0eb92509ff2a90d189bda51fdd298fa1cffd4e8d79095f104c073a2b71cf61c727f4e5718cb7ea2f8fc6d7694bf3b40764234dfbe0d35f40f557545e1729ca639be4f1bcdc9028cb590b3ad3fd176bfea3cef13e57db057b3bae7ae8553a454515aecb21e4c58c670b19d8ee12668ab8af16d56b285153589eb85d15cd9e56fe459b",
		Fmspc:    "20606a000000",
		Ca:       "processor",
		Manifest: "178e874b49e44aa599bb3057170925b41d6e010000000000000000000000000084947ac684404189902a7e76cd658926bc010100000000000000000000000000e5db57cfd1af3e45ddfbd7f52e74a44871d542e3893c9f6f88ef999a7969eacc38e156d8233e6479997f6daa3553d902bb6a7fd6e6db21c43c13993c91c2eb95b6654b70d3e1602d5c236f9c5e8209a6a9923f49628eb7ba934913ccee4ae3df1c9ce11d0dac1c2e6ebbeb7b036e1288ad98d0aac44e5dbe3e01ea40eb7301c513c388d7e87b6630fcee23dccc28e5466a3669137e79021e386db75569606a481ac81bcd03fdc30a142bce8cca274dc044f2b40dc9abaef952bb4f0d01058d590d6950cd56bd036c7385272789e38de9b7302fafd5514248de83c18aedc9fb3c4a60754b41d8038be2c85d9e109742450b76989ff262cb0a7a979546018c7c76109ec6dd7965eead462bbd1edf6124e4a7da00de497408e44869496138cc1383f2caef7b6bf456c1f494c2b539e1741d904515414816a5096e96350b5decc84cdb9c29fe6ffa7a1982b55fe6fb258e18f03c1724b296aab446a9f4e10de1d49485f4360dfade7bc6abf70c0f1ed59c15ab30face19e3cfee43e1bee2f2800095576af52b46344ea4e7e08c2bc1d568dd01000100bcf7744b0929b513d15794280f82233b5684b73af7f86c073d1ecec86f6cd34c0000010001000000fd8f5c411b614b97a74796f08926757b39050100000000000000000000000000200000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
		HwUUID:   uuid.MustParse("ee37c360-7eae-4250-a677-6ee12adce8e2"),
	}
	err := cachePlatformInfo(db, platform, constants.CacheInsert)
	assert.Nil(t, err)

	err = cachePlatformInfo(db, platform, constants.CacheRefresh)
	assert.Nil(t, err)

	// negative tests

	db.PlatformRepository().Create(platform)
	err = cachePlatformInfo(db, platform, constants.CacheInsert)
	assert.NotNil(t, err)

	platform.QeID = ""
	platform.PceID = ""
	err = cachePlatformInfo(db, platform, constants.CacheRefresh)
	assert.NotNil(t, err)
}

func TestCachePlatformTcbInfo(t *testing.T) {
	db := getMockDatabase()
	platform := &types.Platform{
		QeID:     "0518145496973c5e69577195511e9080",
		PceID:    "0000",
		CPUSvn:   "1bf8deed6f929ce40bd658e61ea722eb",
		PceSvn:   "0a00",
		Encppid:  "00f51b4272163732be2101ee62dfdb175205a5179c5b5faff4b2ae103cb1150ef7d4e6041775543930600e41dd2e6aee7f40790f5a0380f6b29b1f1f7e6aad75bfa666153bb325c6db5b67f694d14bff98996c4994ce153278bfeb1b455dd4acbeacc97df6a3cd439a838218c1e07dae91a62195b803b9d3808d5b8470d46b0af3f275b6f6573871eb4eeb43ed9c5a5647729f25648fa74f1ce43621618b266abde6f44e92ce65bbbbe2c50e3e7a8b84d1ed38f53a1d99d3f15fc8c39b0ee568580c37a4eb19dbe87cd447c78f05544684701c01e64e0273dc69c27e46f732f7a7ee8cc4dfaf3b921bf6bbc3ee83f8de5f4e86039595cddaf7cadfce599f0eb92509ff2a90d189bda51fdd298fa1cffd4e8d79095f104c073a2b71cf61c727f4e5718cb7ea2f8fc6d7694bf3b40764234dfbe0d35f40f557545e1729ca639be4f1bcdc9028cb590b3ad3fd176bfea3cef13e57db057b3bae7ae8553a454515aecb21e4c58c670b19d8ee12668ab8af16d56b285153589eb85d15cd9e56fe459b",
		Fmspc:    "20606a000000",
		Ca:       "processor",
		Manifest: "178e874b49e44aa599bb3057170925b41d6e010000000000000000000000000084947ac684404189902a7e76cd658926bc010100000000000000000000000000e5db57cfd1af3e45ddfbd7f52e74a44871d542e3893c9f6f88ef999a7969eacc38e156d8233e6479997f6daa3553d902bb6a7fd6e6db21c43c13993c91c2eb95b6654b70d3e1602d5c236f9c5e8209a6a9923f49628eb7ba934913ccee4ae3df1c9ce11d0dac1c2e6ebbeb7b036e1288ad98d0aac44e5dbe3e01ea40eb7301c513c388d7e87b6630fcee23dccc28e5466a3669137e79021e386db75569606a481ac81bcd03fdc30a142bce8cca274dc044f2b40dc9abaef952bb4f0d01058d590d6950cd56bd036c7385272789e38de9b7302fafd5514248de83c18aedc9fb3c4a60754b41d8038be2c85d9e109742450b76989ff262cb0a7a979546018c7c76109ec6dd7965eead462bbd1edf6124e4a7da00de497408e44869496138cc1383f2caef7b6bf456c1f494c2b539e1741d904515414816a5096e96350b5decc84cdb9c29fe6ffa7a1982b55fe6fb258e18f03c1724b296aab446a9f4e10de1d49485f4360dfade7bc6abf70c0f1ed59c15ab30face19e3cfee43e1bee2f2800095576af52b46344ea4e7e08c2bc1d568dd01000100bcf7744b0929b513d15794280f82233b5684b73af7f86c073d1ecec86f6cd34c0000010001000000fd8f5c411b614b97a74796f08926757b39050100000000000000000000000000200000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
		HwUUID:   uuid.MustParse("ee37c360-7eae-4250-a677-6ee12adce8e2"),
	}

	thisPlatformTcb := &types.PlatformTcb{
		QeID:   "0518145496973c5e69577195511e9080",
		PceID:  "0000",
		CPUSvn: "1bf8deed6f929ce40bd658e61ea722eb",
		PceSvn: "0a00",
	}

	err := cachePlatformTcbInfo(db, platform, "030300000000000000000000000000000A00", constants.CacheInsert)
	assert.Nil(t, err)

	err = cachePlatformTcbInfo(db, platform, "030300000000000000000000000000000A00", constants.CacheRefresh)
	assert.Nil(t, err)
	// negative tests
	db.PlatformTcbRepository().Create(thisPlatformTcb)
	err = cachePlatformTcbInfo(db, platform, "030300000000000000000000000000000A00", constants.CacheInsert)
	assert.NotNil(t, err)

	platform.QeID = ""
	platform.PceID = ""
	err = cachePlatformTcbInfo(db, platform, "030300000000000000000000000000000A00", constants.CacheRefresh)
	assert.NotNil(t, err)
}

func TestCheckPlatformDataCacheStatus(t *testing.T) {

	db := getMockDatabase()

	platformInfo := PlatformInfo{
		QeID:     "0518145496973c5e69577195511e9080",
		PceID:    "0000",
		CPUSvn:   "1bf8deed6f929ce40bd658e61ea722eb",
		PceSvn:   "0a00",
		EncPpid:  "00f51b4272163732be2101ee62dfdb175205a5179c5b5faff4b2ae103cb1150ef7d4e6041775543930600e41dd2e6aee7f40790f5a0380f6b29b1f1f7e6aad75bfa666153bb325c6db5b67f694d14bff98996c4994ce153278bfeb1b455dd4acbeacc97df6a3cd439a838218c1e07dae91a62195b803b9d3808d5b8470d46b0af3f275b6f6573871eb4eeb43ed9c5a5647729f25648fa74f1ce43621618b266abde6f44e92ce65bbbbe2c50e3e7a8b84d1ed38f53a1d99d3f15fc8c39b0ee568580c37a4eb19dbe87cd447c78f05544684701c01e64e0273dc69c27e46f732f7a7ee8cc4dfaf3b921bf6bbc3ee83f8de5f4e86039595cddaf7cadfce599f0eb92509ff2a90d189bda51fdd298fa1cffd4e8d79095f104c073a2b71cf61c727f4e5718cb7ea2f8fc6d7694bf3b40764234dfbe0d35f40f557545e1729ca639be4f1bcdc9028cb590b3ad3fd176bfea3cef13e57db057b3bae7ae8553a454515aecb21e4c58c670b19d8ee12668ab8af16d56b285153589eb85d15cd9e56fe459b",
		Manifest: "178e874b49e44aa599bb3057170925b41d6e010000000000000000000000000084947ac684404189902a7e76cd658926bc010100000000000000000000000000e5db57cfd1af3e45ddfbd7f52e74a44871d542e3893c9f6f88ef999a7969eacc38e156d8233e6479997f6daa3553d902bb6a7fd6e6db21c43c13993c91c2eb95b6654b70d3e1602d5c236f9c5e8209a6a9923f49628eb7ba934913ccee4ae3df1c9ce11d0dac1c2e6ebbeb7b036e1288ad98d0aac44e5dbe3e01ea40eb7301c513c388d7e87b6630fcee23dccc28e5466a3669137e79021e386db75569606a481ac81bcd03fdc30a142bce8cca274dc044f2b40dc9abaef952bb4f0d01058d590d6950cd56bd036c7385272789e38de9b7302fafd5514248de83c18aedc9fb3c4a60754b41d8038be2c85d9e109742450b76989ff262cb0a7a979546018c7c76109ec6dd7965eead462bbd1edf6124e4a7da00de497408e44869496138cc1383f2caef7b6bf456c1f494c2b539e1741d904515414816a5096e96350b5decc84cdb9c29fe6ffa7a1982b55fe6fb258e18f03c1724b296aab446a9f4e10de1d49485f4360dfade7bc6abf70c0f1ed59c15ab30face19e3cfee43e1bee2f2800095576af52b46344ea4e7e08c2bc1d568dd01000100bcf7744b0929b513d15794280f82233b5684b73af7f86c073d1ecec86f6cd34c0000010001000000fd8f5c411b614b97a74796f08926757b39050100000000000000000000000000200000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
		HwUUID:   "ee37c360-7eae-4250-a677-6ee12adce8e2",
	}

	platform := &types.Platform{
		QeID:     "0518145496973c5e69577195511e9080",
		PceID:    "0000",
		CPUSvn:   "1bf8deed6f929ce40bd658e61ea722eb",
		PceSvn:   "0a00",
		Encppid:  "00f51b4272163732be2101ee62dfdb175205a5179c5b5faff4b2ae103cb1150ef7d4e6041775543930600e41dd2e6aee7f40790f5a0380f6b29b1f1f7e6aad75bfa666153bb325c6db5b67f694d14bff98996c4994ce153278bfeb1b455dd4acbeacc97df6a3cd439a838218c1e07dae91a62195b803b9d3808d5b8470d46b0af3f275b6f6573871eb4eeb43ed9c5a5647729f25648fa74f1ce43621618b266abde6f44e92ce65bbbbe2c50e3e7a8b84d1ed38f53a1d99d3f15fc8c39b0ee568580c37a4eb19dbe87cd447c78f05544684701c01e64e0273dc69c27e46f732f7a7ee8cc4dfaf3b921bf6bbc3ee83f8de5f4e86039595cddaf7cadfce599f0eb92509ff2a90d189bda51fdd298fa1cffd4e8d79095f104c073a2b71cf61c727f4e5718cb7ea2f8fc6d7694bf3b40764234dfbe0d35f40f557545e1729ca639be4f1bcdc9028cb590b3ad3fd176bfea3cef13e57db057b3bae7ae8553a454515aecb21e4c58c670b19d8ee12668ab8af16d56b285153589eb85d15cd9e56fe459b",
		Fmspc:    "20606a000000",
		Ca:       "processor",
		Manifest: "178e874b49e44aa599bb3057170925b41d6e010000000000000000000000000084947ac684404189902a7e76cd658926bc010100000000000000000000000000e5db57cfd1af3e45ddfbd7f52e74a44871d542e3893c9f6f88ef999a7969eacc38e156d8233e6479997f6daa3553d902bb6a7fd6e6db21c43c13993c91c2eb95b6654b70d3e1602d5c236f9c5e8209a6a9923f49628eb7ba934913ccee4ae3df1c9ce11d0dac1c2e6ebbeb7b036e1288ad98d0aac44e5dbe3e01ea40eb7301c513c388d7e87b6630fcee23dccc28e5466a3669137e79021e386db75569606a481ac81bcd03fdc30a142bce8cca274dc044f2b40dc9abaef952bb4f0d01058d590d6950cd56bd036c7385272789e38de9b7302fafd5514248de83c18aedc9fb3c4a60754b41d8038be2c85d9e109742450b76989ff262cb0a7a979546018c7c76109ec6dd7965eead462bbd1edf6124e4a7da00de497408e44869496138cc1383f2caef7b6bf456c1f494c2b539e1741d904515414816a5096e96350b5decc84cdb9c29fe6ffa7a1982b55fe6fb258e18f03c1724b296aab446a9f4e10de1d49485f4360dfade7bc6abf70c0f1ed59c15ab30face19e3cfee43e1bee2f2800095576af52b46344ea4e7e08c2bc1d568dd01000100bcf7744b0929b513d15794280f82233b5684b73af7f86c073d1ecec86f6cd34c0000010001000000fd8f5c411b614b97a74796f08926757b39050100000000000000000000000000200000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
		HwUUID:   uuid.MustParse("ee37c360-7eae-4250-a677-6ee12adce8e2"),
	}
	db.PlatformRepository().Create(platform)

	_, err := checkPlatformDataCacheStatus(db, &platformInfo, platformInfo.HwUUID)
	assert.Nil(t, err)

	// invalid tokenSubject
	_, err = checkPlatformDataCacheStatus(db, &platformInfo, "ee37c360-7eae-4250-a677-6ee13adce8e2")
	assert.NotNil(t, err)

	platformInfo.Manifest = ""
	_, err = checkPlatformDataCacheStatus(db, &platformInfo, platformInfo.HwUUID)
	assert.NotNil(t, err)

	newPckCert := &types.PckCert{
		QeID:      "0518145496973c5e69577195511e9080",
		PceID:     "0000",
		CertIndex: 0,
		Tcbms:     []string{"030300000000000000000000000000000A00"},
		Fmspc:     "20606a000000",
		PckCerts:  []string{"-----BEGIN%20CERTIFICATE-----%0AMIIE9DCCBJqgAwIBAgIUb6rZwuxZc5cIkp6%2Foqqz7HdGyFwwCgYIKoZIzj0EAwIw%0AcDEiMCAGA1UEAwwZSW50ZWwgU0dYIFBDSyBQbGF0Zm9ybSBDQTEaMBgGA1UECgwR%0ASW50ZWwgQ29ycG9yYXRpb24xFDASBgNVBAcMC1NhbnRhIENsYXJhMQswCQYDVQQI%0ADAJDQTELMAkGA1UEBhMCVVMwHhcNMjIwNjIxMTEyNDU2WhcNMjkwNjIxMTEyNDU2%0AWjBwMSIwIAYDVQQDDBlJbnRlbCBTR1ggUENLIENlcnRpZmljYXRlMRowGAYDVQQK%0ADBFJbnRlbCBDb3Jwb3JhdGlvbjEUMBIGA1UEBwwLU2FudGEgQ2xhcmExCzAJBgNV%0ABAgMAkNBMQswCQYDVQQGEwJVUzBZMBMGByqGSM49AgEGCCqGSM49AwEHA0IABOB3%0AWFm1ziJAlu79StgxfAuz8AWCkoiraneuAGgrFExeiukczJvjWdtDTM2O7w8GiZAt%0A1h84AyDRUb%2BHoNaflACjggMQMIIDDDAfBgNVHSMEGDAWgBRZI9OnSqhjVC45cK3g%0ADwcrVyQqtzBvBgNVHR8EaDBmMGSgYqBghl5odHRwczovL3NieC5hcGkudHJ1c3Rl%0AZHNlcnZpY2VzLmludGVsLmNvbS9zZ3gvY2VydGlmaWNhdGlvbi92My9wY2tjcmw%2F%0AY2E9cGxhdGZvcm0mZW5jb2Rpbmc9ZGVyMB0GA1UdDgQWBBQ6mE6WHjgoVSRiUaG%2F%0A0QmQDpX7LjAOBgNVHQ8BAf8EBAMCBsAwDAYDVR0TAQH%2FBAIwADCCAjkGCSqGSIb4%0ATQENAQSCAiowggImMB4GCiqGSIb4TQENAQEEEGzzoSC5Btq3aBE%2BWYxHhwUwggFj%0ABgoqhkiG%2BE0BDQECMIIBUzAQBgsqhkiG%2BE0BDQECAQIBATAQBgsqhkiG%2BE0BDQEC%0AAgIBATAQBgsqhkiG%2BE0BDQECAwIBADAQBgsqhkiG%2BE0BDQECBAIBADAQBgsqhkiG%0A%2BE0BDQECBQIBADAQBgsqhkiG%2BE0BDQECBgIBADAQBgsqhkiG%2BE0BDQECBwIBADAQ%0ABgsqhkiG%2BE0BDQECCAIBADAQBgsqhkiG%2BE0BDQECCQIBADAQBgsqhkiG%2BE0BDQEC%0ACgIBADAQBgsqhkiG%2BE0BDQECCwIBADAQBgsqhkiG%2BE0BDQECDAIBADAQBgsqhkiG%0A%2BE0BDQECDQIBADAQBgsqhkiG%2BE0BDQECDgIBADAQBgsqhkiG%2BE0BDQECDwIBADAQ%0ABgsqhkiG%2BE0BDQECEAIBADAQBgsqhkiG%2BE0BDQECEQIBCTAfBgsqhkiG%2BE0BDQEC%0AEgQQAQEAAAAAAAAAAAAAAAAAADAQBgoqhkiG%2BE0BDQEDBAIAADAUBgoqhkiG%2BE0B%0ADQEEBAYQYGoAAAAwDwYKKoZIhvhNAQ0BBQoBATAeBgoqhkiG%2BE0BDQEGBBDjJ4f6%0AieS5MJrtZWT28t9KMEQGCiqGSIb4TQENAQcwNjAQBgsqhkiG%2BE0BDQEHAQEB%2FzAQ%0ABgsqhkiG%2BE0BDQEHAgEBADAQBgsqhkiG%2BE0BDQEHAwEB%2FzAKBggqhkjOPQQDAgNI%0AADBFAiBJwRZ5Dkvmz41SMH%2FFojZqiPxfzpQo78iqcvTdo0DwTQIhAPzZkuFcwZUV%0Al0yBja8lgLWp%2F8eMKpx5hOAw1dDV2iST%0A-----END%20CERTIFICATE-----%0A"},
	}
	db.PckCertRepository().Create(newPckCert)
	platformInfo.Manifest = ""
	_, err = checkPlatformDataCacheStatus(db, &platformInfo, platformInfo.HwUUID)
	assert.Nil(t, err)
}

func TestRefreshPckCerts(t *testing.T) {

	db := getMockDatabase()
	platform := &types.Platform{
		QeID:     "0518145496973c5e69577195511e9080",
		PceID:    "0000",
		CPUSvn:   "1bf8deed6f929ce40bd658e61ea722eb",
		PceSvn:   "0a00",
		Encppid:  "00f51b4272163732be2101ee62dfdb175205a5179c5b5faff4b2ae103cb1150ef7d4e6041775543930600e41dd2e6aee7f40790f5a0380f6b29b1f1f7e6aad75bfa666153bb325c6db5b67f694d14bff98996c4994ce153278bfeb1b455dd4acbeacc97df6a3cd439a838218c1e07dae91a62195b803b9d3808d5b8470d46b0af3f275b6f6573871eb4eeb43ed9c5a5647729f25648fa74f1ce43621618b266abde6f44e92ce65bbbbe2c50e3e7a8b84d1ed38f53a1d99d3f15fc8c39b0ee568580c37a4eb19dbe87cd447c78f05544684701c01e64e0273dc69c27e46f732f7a7ee8cc4dfaf3b921bf6bbc3ee83f8de5f4e86039595cddaf7cadfce599f0eb92509ff2a90d189bda51fdd298fa1cffd4e8d79095f104c073a2b71cf61c727f4e5718cb7ea2f8fc6d7694bf3b40764234dfbe0d35f40f557545e1729ca639be4f1bcdc9028cb590b3ad3fd176bfea3cef13e57db057b3bae7ae8553a454515aecb21e4c58c670b19d8ee12668ab8af16d56b285153589eb85d15cd9e56fe459b",
		Fmspc:    "20606a000000",
		Ca:       "processor",
		Manifest: "178e874b49e44aa599bb3057170925b41d6e010000000000000000000000000084947ac684404189902a7e76cd658926bc010100000000000000000000000000e5db57cfd1af3e45ddfbd7f52e74a44871d542e3893c9f6f88ef999a7969eacc38e156d8233e6479997f6daa3553d902bb6a7fd6e6db21c43c13993c91c2eb95b6654b70d3e1602d5c236f9c5e8209a6a9923f49628eb7ba934913ccee4ae3df1c9ce11d0dac1c2e6ebbeb7b036e1288ad98d0aac44e5dbe3e01ea40eb7301c513c388d7e87b6630fcee23dccc28e5466a3669137e79021e386db75569606a481ac81bcd03fdc30a142bce8cca274dc044f2b40dc9abaef952bb4f0d01058d590d6950cd56bd036c7385272789e38de9b7302fafd5514248de83c18aedc9fb3c4a60754b41d8038be2c85d9e109742450b76989ff262cb0a7a979546018c7c76109ec6dd7965eead462bbd1edf6124e4a7da00de497408e44869496138cc1383f2caef7b6bf456c1f494c2b539e1741d904515414816a5096e96350b5decc84cdb9c29fe6ffa7a1982b55fe6fb258e18f03c1724b296aab446a9f4e10de1d49485f4360dfade7bc6abf70c0f1ed59c15ab30face19e3cfee43e1bee2f2800095576af52b46344ea4e7e08c2bc1d568dd01000100bcf7744b0929b513d15794280f82233b5684b73af7f86c073d1ecec86f6cd34c0000010001000000fd8f5c411b614b97a74796f08926757b39050100000000000000000000000000200000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
		HwUUID:   uuid.MustParse("ee37c360-7eae-4250-a677-6ee12adce8e2"),
	}
	db.PlatformRepository().Create(platform)

	conf := config.Load(testConfigFilePath)
	client := mocks.NewClientMock(200)
	err := refreshPckCerts(db, conf, &client)
	assert.NotNil(t, err)

}

func TestRefreshAllPckCrl(t *testing.T) {

	db := getMockDatabase()
	pckCrl := &types.PckCrl{
		Ca:              "processor",
		PckCrlCertChain: "-----BEGIN%20CERTIFICATE-----%0AMIIE9DCCBJqgAwIBAgIUb6rZwuxZc5cIkp6%2Foqqz7HdGyFwwCgYIKoZIzj0EAwIw%0AcDEiMCAGA1UEAwwZSW50ZWwgU0dYIFBDSyBQbGF0Zm9ybSBDQTEaMBgGA1UECgwR%0ASW50ZWwgQ29ycG9yYXRpb24xFDASBgNVBAcMC1NhbnRhIENsYXJhMQswCQYDVQQI%0ADAJDQTELMAkGA1UEBhMCVVMwHhcNMjIwNjIxMTEyNDU2WhcNMjkwNjIxMTEyNDU2%0AWjBwMSIwIAYDVQQDDBlJbnRlbCBTR1ggUENLIENlcnRpZmljYXRlMRowGAYDVQQK%0ADBFJbnRlbCBDb3Jwb3JhdGlvbjEUMBIGA1UEBwwLU2FudGEgQ2xhcmExCzAJBgNV%0ABAgMAkNBMQswCQYDVQQGEwJVUzBZMBMGByqGSM49AgEGCCqGSM49AwEHA0IABOB3%0AWFm1ziJAlu79StgxfAuz8AWCkoiraneuAGgrFExeiukczJvjWdtDTM2O7w8GiZAt%0A1h84AyDRUb%2BHoNaflACjggMQMIIDDDAfBgNVHSMEGDAWgBRZI9OnSqhjVC45cK3g%0ADwcrVyQqtzBvBgNVHR8EaDBmMGSgYqBghl5odHRwczovL3NieC5hcGkudHJ1c3Rl%0AZHNlcnZpY2VzLmludGVsLmNvbS9zZ3gvY2VydGlmaWNhdGlvbi92My9wY2tjcmw%2F%0AY2E9cGxhdGZvcm0mZW5jb2Rpbmc9ZGVyMB0GA1UdDgQWBBQ6mE6WHjgoVSRiUaG%2F%0A0QmQDpX7LjAOBgNVHQ8BAf8EBAMCBsAwDAYDVR0TAQH%2FBAIwADCCAjkGCSqGSIb4%0ATQENAQSCAiowggImMB4GCiqGSIb4TQENAQEEEGzzoSC5Btq3aBE%2BWYxHhwUwggFj%0ABgoqhkiG%2BE0BDQECMIIBUzAQBgsqhkiG%2BE0BDQECAQIBATAQBgsqhkiG%2BE0BDQEC%0AAgIBATAQBgsqhkiG%2BE0BDQECAwIBADAQBgsqhkiG%2BE0BDQECBAIBADAQBgsqhkiG%0A%2BE0BDQECBQIBADAQBgsqhkiG%2BE0BDQECBgIBADAQBgsqhkiG%2BE0BDQECBwIBADAQ%0ABgsqhkiG%2BE0BDQECCAIBADAQBgsqhkiG%2BE0BDQECCQIBADAQBgsqhkiG%2BE0BDQEC%0ACgIBADAQBgsqhkiG%2BE0BDQECCwIBADAQBgsqhkiG%2BE0BDQECDAIBADAQBgsqhkiG%0A%2BE0BDQECDQIBADAQBgsqhkiG%2BE0BDQECDgIBADAQBgsqhkiG%2BE0BDQECDwIBADAQ%0ABgsqhkiG%2BE0BDQECEAIBADAQBgsqhkiG%2BE0BDQECEQIBCTAfBgsqhkiG%2BE0BDQEC%0AEgQQAQEAAAAAAAAAAAAAAAAAADAQBgoqhkiG%2BE0BDQEDBAIAADAUBgoqhkiG%2BE0B%0ADQEEBAYQYGoAAAAwDwYKKoZIhvhNAQ0BBQoBATAeBgoqhkiG%2BE0BDQEGBBDjJ4f6%0AieS5MJrtZWT28t9KMEQGCiqGSIb4TQENAQcwNjAQBgsqhkiG%2BE0BDQEHAQEB%2FzAQ%0ABgsqhkiG%2BE0BDQEHAgEBADAQBgsqhkiG%2BE0BDQEHAwEB%2FzAKBggqhkjOPQQDAgNI%0AADBFAiBJwRZ5Dkvmz41SMH%2FFojZqiPxfzpQo78iqcvTdo0DwTQIhAPzZkuFcwZUV%0Al0yBja8lgLWp%2F8eMKpx5hOAw1dDV2iST%0A-----END%20CERTIFICATE-----%0A",
	}
	db.PckCrlRepository().Create(pckCrl)

	conf := config.Load(testConfigFilePath)
	client := mocks.NewClientMock(200)
	err := refreshAllPckCrl(db, conf, &client)
	assert.Nil(t, err)
	// Empty configuration given
	err = refreshAllPckCrl(db, nil, &client)
	assert.NotNil(t, err)
}

func TestRefreshAllTcbInfo(t *testing.T) {

	db := getMockDatabase()
	var tcbInfoJson TcbInfoJSON

	json.Unmarshal(testTcbInfoJson, &tcbInfoJson)

	tcbInfo := &types.FmspcTcbInfo{
		Fmspc:   "20606a000000",
		TcbInfo: string(testTcbInfoJson),
	}
	db.FmspcTcbInfoRepository().Create(tcbInfo)

	conf := config.Load(testConfigFilePath)
	client := mocks.NewClientMock(200)
	err := refreshAllTcbInfo(db, conf, &client)
	assert.Nil(t, err)
	// Empty configuration given
	err = refreshAllTcbInfo(db, nil, &client)
	assert.NotNil(t, err)
}

func TestRefreshAllQE(t *testing.T) {

	db := getMockDatabase()
	qeIdentity := &types.QEIdentity{
		ID:            "73d1aac0-83db-4c40-8c11-6dfe5d4f4f0e",
		QeInfo:        string(qeInfo),
		QeIssuerChain: "-----BEGIN%20CERTIFICATE-----%0AMIIE9DCCBJqgAwIBAgIUb6rZwuxZc5cIkp6%2Foqqz7HdGyFwwCgYIKoZIzj0EAwIw%0AcDEiMCAGA1UEAwwZSW50ZWwgU0dYIFBDSyBQbGF0Zm9ybSBDQTEaMBgGA1UECgwR%0ASW50ZWwgQ29ycG9yYXRpb24xFDASBgNVBAcMC1NhbnRhIENsYXJhMQswCQYDVQQI%0ADAJDQTELMAkGA1UEBhMCVVMwHhcNMjIwNjIxMTEyNDU2WhcNMjkwNjIxMTEyNDU2%0AWjBwMSIwIAYDVQQDDBlJbnRlbCBTR1ggUENLIENlcnRpZmljYXRlMRowGAYDVQQK%0ADBFJbnRlbCBDb3Jwb3JhdGlvbjEUMBIGA1UEBwwLU2FudGEgQ2xhcmExCzAJBgNV%0ABAgMAkNBMQswCQYDVQQGEwJVUzBZMBMGByqGSM49AgEGCCqGSM49AwEHA0IABOB3%0AWFm1ziJAlu79StgxfAuz8AWCkoiraneuAGgrFExeiukczJvjWdtDTM2O7w8GiZAt%0A1h84AyDRUb%2BHoNaflACjggMQMIIDDDAfBgNVHSMEGDAWgBRZI9OnSqhjVC45cK3g%0ADwcrVyQqtzBvBgNVHR8EaDBmMGSgYqBghl5odHRwczovL3NieC5hcGkudHJ1c3Rl%0AZHNlcnZpY2VzLmludGVsLmNvbS9zZ3gvY2VydGlmaWNhdGlvbi92My9wY2tjcmw%2F%0AY2E9cGxhdGZvcm0mZW5jb2Rpbmc9ZGVyMB0GA1UdDgQWBBQ6mE6WHjgoVSRiUaG%2F%0A0QmQDpX7LjAOBgNVHQ8BAf8EBAMCBsAwDAYDVR0TAQH%2FBAIwADCCAjkGCSqGSIb4%0ATQENAQSCAiowggImMB4GCiqGSIb4TQENAQEEEGzzoSC5Btq3aBE%2BWYxHhwUwggFj%0ABgoqhkiG%2BE0BDQECMIIBUzAQBgsqhkiG%2BE0BDQECAQIBATAQBgsqhkiG%2BE0BDQEC%0AAgIBATAQBgsqhkiG%2BE0BDQECAwIBADAQBgsqhkiG%2BE0BDQECBAIBADAQBgsqhkiG%0A%2BE0BDQECBQIBADAQBgsqhkiG%2BE0BDQECBgIBADAQBgsqhkiG%2BE0BDQECBwIBADAQ%0ABgsqhkiG%2BE0BDQECCAIBADAQBgsqhkiG%2BE0BDQECCQIBADAQBgsqhkiG%2BE0BDQEC%0ACgIBADAQBgsqhkiG%2BE0BDQECCwIBADAQBgsqhkiG%2BE0BDQECDAIBADAQBgsqhkiG%0A%2BE0BDQECDQIBADAQBgsqhkiG%2BE0BDQECDgIBADAQBgsqhkiG%2BE0BDQECDwIBADAQ%0ABgsqhkiG%2BE0BDQECEAIBADAQBgsqhkiG%2BE0BDQECEQIBCTAfBgsqhkiG%2BE0BDQEC%0AEgQQAQEAAAAAAAAAAAAAAAAAADAQBgoqhkiG%2BE0BDQEDBAIAADAUBgoqhkiG%2BE0B%0ADQEEBAYQYGoAAAAwDwYKKoZIhvhNAQ0BBQoBATAeBgoqhkiG%2BE0BDQEGBBDjJ4f6%0AieS5MJrtZWT28t9KMEQGCiqGSIb4TQENAQcwNjAQBgsqhkiG%2BE0BDQEHAQEB%2FzAQ%0ABgsqhkiG%2BE0BDQEHAgEBADAQBgsqhkiG%2BE0BDQEHAwEB%2FzAKBggqhkjOPQQDAgNI%0AADBFAiBJwRZ5Dkvmz41SMH%2FFojZqiPxfzpQo78iqcvTdo0DwTQIhAPzZkuFcwZUV%0Al0yBja8lgLWp%2F8eMKpx5hOAw1dDV2iST%0A-----END%20CERTIFICATE-----%0A",
	}

	db.QEIdentityRepository().Create(qeIdentity)

	conf := config.Load(testConfigFilePath)
	client := mocks.NewClientMock(200)
	err := refreshAllQE(db, conf, &client)
	assert.Nil(t, err)
	// Empty configuration given
	err = refreshAllQE(db, nil, &client)
	assert.NotNil(t, err)
}

func TestRefreshNonPCKCollaterals(t *testing.T) {

	db := getMockDatabase()
	conf := config.Load(testConfigFilePath)
	client := mocks.NewClientMock(200)

	// No PCK CRL data provided
	err := refreshNonPCKCollaterals(db, conf, &client)
	assert.NotNil(t, err)

	platform := &types.Platform{
		QeID:     "1518145496973c5e69577195511e9080",
		PceID:    "1000",
		CPUSvn:   "1bf8deed6f929ce40bd658e61ea722eb",
		PceSvn:   "0a00",
		Encppid:  "00f51b4272163732be2101ee62dfdb175205a5179c5b5faff4b2ae103cb1150ef7d4e6041775543930600e41dd2e6aee7f40790f5a0380f6b29b1f1f7e6aad75bfa666153bb325c6db5b67f694d14bff98996c4994ce153278bfeb1b455dd4acbeacc97df6a3cd439a838218c1e07dae91a62195b803b9d3808d5b8470d46b0af3f275b6f6573871eb4eeb43ed9c5a5647729f25648fa74f1ce43621618b266abde6f44e92ce65bbbbe2c50e3e7a8b84d1ed38f53a1d99d3f15fc8c39b0ee568580c37a4eb19dbe87cd447c78f05544684701c01e64e0273dc69c27e46f732f7a7ee8cc4dfaf3b921bf6bbc3ee83f8de5f4e86039595cddaf7cadfce599f0eb92509ff2a90d189bda51fdd298fa1cffd4e8d79095f104c073a2b71cf61c727f4e5718cb7ea2f8fc6d7694bf3b40764234dfbe0d35f40f557545e1729ca639be4f1bcdc9028cb590b3ad3fd176bfea3cef13e57db057b3bae7ae8553a454515aecb21e4c58c670b19d8ee12668ab8af16d56b285153589eb85d15cd9e56fe459b",
		Fmspc:    "20606a000000",
		Ca:       "processor",
		Manifest: "178e874b49e44aa599bb3057170925b41d6e010000000000000000000000000084947ac684404189902a7e76cd658926bc010100000000000000000000000000e5db57cfd1af3e45ddfbd7f52e74a44871d542e3893c9f6f88ef999a7969eacc38e156d8233e6479997f6daa3553d902bb6a7fd6e6db21c43c13993c91c2eb95b6654b70d3e1602d5c236f9c5e8209a6a9923f49628eb7ba934913ccee4ae3df1c9ce11d0dac1c2e6ebbeb7b036e1288ad98d0aac44e5dbe3e01ea40eb7301c513c388d7e87b6630fcee23dccc28e5466a3669137e79021e386db75569606a481ac81bcd03fdc30a142bce8cca274dc044f2b40dc9abaef952bb4f0d01058d590d6950cd56bd036c7385272789e38de9b7302fafd5514248de83c18aedc9fb3c4a60754b41d8038be2c85d9e109742450b76989ff262cb0a7a979546018c7c76109ec6dd7965eead462bbd1edf6124e4a7da00de497408e44869496138cc1383f2caef7b6bf456c1f494c2b539e1741d904515414816a5096e96350b5decc84cdb9c29fe6ffa7a1982b55fe6fb258e18f03c1724b296aab446a9f4e10de1d49485f4360dfade7bc6abf70c0f1ed59c15ab30face19e3cfee43e1bee2f2800095576af52b46344ea4e7e08c2bc1d568dd01000100bcf7744b0929b513d15794280f82233b5684b73af7f86c073d1ecec86f6cd34c0000010001000000fd8f5c411b614b97a74796f08926757b39050100000000000000000000000000200000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
		HwUUID:   uuid.MustParse("ee37c360-7eae-4250-a677-6ee12adce8e2"),
	}
	db.PlatformRepository().Create(platform)

	pckCrl := &types.PckCrl{
		Ca:              "processor1",
		PckCrlCertChain: "-----BEGIN%20CERTIFICATE-----%0AMIIE9DCCBJqgAwIBAgIUb6rZwuxZc5cIkp6%2Foqqz7HdGyFwwCgYIKoZIzj0EAwIw%0AcDEiMCAGA1UEAwwZSW50ZWwgU0dYIFBDSyBQbGF0Zm9ybSBDQTEaMBgGA1UECgwR%0ASW50ZWwgQ29ycG9yYXRpb24xFDASBgNVBAcMC1NhbnRhIENsYXJhMQswCQYDVQQI%0ADAJDQTELMAkGA1UEBhMCVVMwHhcNMjIwNjIxMTEyNDU2WhcNMjkwNjIxMTEyNDU2%0AWjBwMSIwIAYDVQQDDBlJbnRlbCBTR1ggUENLIENlcnRpZmljYXRlMRowGAYDVQQK%0ADBFJbnRlbCBDb3Jwb3JhdGlvbjEUMBIGA1UEBwwLU2FudGEgQ2xhcmExCzAJBgNV%0ABAgMAkNBMQswCQYDVQQGEwJVUzBZMBMGByqGSM49AgEGCCqGSM49AwEHA0IABOB3%0AWFm1ziJAlu79StgxfAuz8AWCkoiraneuAGgrFExeiukczJvjWdtDTM2O7w8GiZAt%0A1h84AyDRUb%2BHoNaflACjggMQMIIDDDAfBgNVHSMEGDAWgBRZI9OnSqhjVC45cK3g%0ADwcrVyQqtzBvBgNVHR8EaDBmMGSgYqBghl5odHRwczovL3NieC5hcGkudHJ1c3Rl%0AZHNlcnZpY2VzLmludGVsLmNvbS9zZ3gvY2VydGlmaWNhdGlvbi92My9wY2tjcmw%2F%0AY2E9cGxhdGZvcm0mZW5jb2Rpbmc9ZGVyMB0GA1UdDgQWBBQ6mE6WHjgoVSRiUaG%2F%0A0QmQDpX7LjAOBgNVHQ8BAf8EBAMCBsAwDAYDVR0TAQH%2FBAIwADCCAjkGCSqGSIb4%0ATQENAQSCAiowggImMB4GCiqGSIb4TQENAQEEEGzzoSC5Btq3aBE%2BWYxHhwUwggFj%0ABgoqhkiG%2BE0BDQECMIIBUzAQBgsqhkiG%2BE0BDQECAQIBATAQBgsqhkiG%2BE0BDQEC%0AAgIBATAQBgsqhkiG%2BE0BDQECAwIBADAQBgsqhkiG%2BE0BDQECBAIBADAQBgsqhkiG%0A%2BE0BDQECBQIBADAQBgsqhkiG%2BE0BDQECBgIBADAQBgsqhkiG%2BE0BDQECBwIBADAQ%0ABgsqhkiG%2BE0BDQECCAIBADAQBgsqhkiG%2BE0BDQECCQIBADAQBgsqhkiG%2BE0BDQEC%0ACgIBADAQBgsqhkiG%2BE0BDQECCwIBADAQBgsqhkiG%2BE0BDQECDAIBADAQBgsqhkiG%0A%2BE0BDQECDQIBADAQBgsqhkiG%2BE0BDQECDgIBADAQBgsqhkiG%2BE0BDQECDwIBADAQ%0ABgsqhkiG%2BE0BDQECEAIBADAQBgsqhkiG%2BE0BDQECEQIBCTAfBgsqhkiG%2BE0BDQEC%0AEgQQAQEAAAAAAAAAAAAAAAAAADAQBgoqhkiG%2BE0BDQEDBAIAADAUBgoqhkiG%2BE0B%0ADQEEBAYQYGoAAAAwDwYKKoZIhvhNAQ0BBQoBATAeBgoqhkiG%2BE0BDQEGBBDjJ4f6%0AieS5MJrtZWT28t9KMEQGCiqGSIb4TQENAQcwNjAQBgsqhkiG%2BE0BDQEHAQEB%2FzAQ%0ABgsqhkiG%2BE0BDQEHAgEBADAQBgsqhkiG%2BE0BDQEHAwEB%2FzAKBggqhkjOPQQDAgNI%0AADBFAiBJwRZ5Dkvmz41SMH%2FFojZqiPxfzpQo78iqcvTdo0DwTQIhAPzZkuFcwZUV%0Al0yBja8lgLWp%2F8eMKpx5hOAw1dDV2iST%0A-----END%20CERTIFICATE-----%0A",
	}
	db.PckCrlRepository().Create(pckCrl)

	// No TCB INFO data provided
	err = refreshNonPCKCollaterals(db, conf, &client)
	assert.NotNil(t, err)

	var tcbInfoJson TcbInfoJSON

	json.Unmarshal(testTcbInfoJson, &tcbInfoJson)

	tcbInfo := &types.FmspcTcbInfo{
		Fmspc:   "30606a000000",
		TcbInfo: string(testTcbInfoJson),
	}
	db.FmspcTcbInfoRepository().Create(tcbInfo)

	// No qeInfo data provided
	err = refreshNonPCKCollaterals(db, conf, &client)
	assert.NotNil(t, err)

	qeIdentity := &types.QEIdentity{
		ID:            "63d1aac0-83db-4c40-8c11-6dfe5d4f4f0e",
		QeInfo:        string(qeInfo),
		QeIssuerChain: "-----BEGIN%20CERTIFICATE-----%0AMIIE9DCCBJqgAwIBAgIUb6rZwuxZc5cIkp6%2Foqqz7HdGyFwwCgYIKoZIzj0EAwIw%0AcDEiMCAGA1UEAwwZSW50ZWwgU0dYIFBDSyBQbGF0Zm9ybSBDQTEaMBgGA1UECgwR%0ASW50ZWwgQ29ycG9yYXRpb24xFDASBgNVBAcMC1NhbnRhIENsYXJhMQswCQYDVQQI%0ADAJDQTELMAkGA1UEBhMCVVMwHhcNMjIwNjIxMTEyNDU2WhcNMjkwNjIxMTEyNDU2%0AWjBwMSIwIAYDVQQDDBlJbnRlbCBTR1ggUENLIENlcnRpZmljYXRlMRowGAYDVQQK%0ADBFJbnRlbCBDb3Jwb3JhdGlvbjEUMBIGA1UEBwwLU2FudGEgQ2xhcmExCzAJBgNV%0ABAgMAkNBMQswCQYDVQQGEwJVUzBZMBMGByqGSM49AgEGCCqGSM49AwEHA0IABOB3%0AWFm1ziJAlu79StgxfAuz8AWCkoiraneuAGgrFExeiukczJvjWdtDTM2O7w8GiZAt%0A1h84AyDRUb%2BHoNaflACjggMQMIIDDDAfBgNVHSMEGDAWgBRZI9OnSqhjVC45cK3g%0ADwcrVyQqtzBvBgNVHR8EaDBmMGSgYqBghl5odHRwczovL3NieC5hcGkudHJ1c3Rl%0AZHNlcnZpY2VzLmludGVsLmNvbS9zZ3gvY2VydGlmaWNhdGlvbi92My9wY2tjcmw%2F%0AY2E9cGxhdGZvcm0mZW5jb2Rpbmc9ZGVyMB0GA1UdDgQWBBQ6mE6WHjgoVSRiUaG%2F%0A0QmQDpX7LjAOBgNVHQ8BAf8EBAMCBsAwDAYDVR0TAQH%2FBAIwADCCAjkGCSqGSIb4%0ATQENAQSCAiowggImMB4GCiqGSIb4TQENAQEEEGzzoSC5Btq3aBE%2BWYxHhwUwggFj%0ABgoqhkiG%2BE0BDQECMIIBUzAQBgsqhkiG%2BE0BDQECAQIBATAQBgsqhkiG%2BE0BDQEC%0AAgIBATAQBgsqhkiG%2BE0BDQECAwIBADAQBgsqhkiG%2BE0BDQECBAIBADAQBgsqhkiG%0A%2BE0BDQECBQIBADAQBgsqhkiG%2BE0BDQECBgIBADAQBgsqhkiG%2BE0BDQECBwIBADAQ%0ABgsqhkiG%2BE0BDQECCAIBADAQBgsqhkiG%2BE0BDQECCQIBADAQBgsqhkiG%2BE0BDQEC%0ACgIBADAQBgsqhkiG%2BE0BDQECCwIBADAQBgsqhkiG%2BE0BDQECDAIBADAQBgsqhkiG%0A%2BE0BDQECDQIBADAQBgsqhkiG%2BE0BDQECDgIBADAQBgsqhkiG%2BE0BDQECDwIBADAQ%0ABgsqhkiG%2BE0BDQECEAIBADAQBgsqhkiG%2BE0BDQECEQIBCTAfBgsqhkiG%2BE0BDQEC%0AEgQQAQEAAAAAAAAAAAAAAAAAADAQBgoqhkiG%2BE0BDQEDBAIAADAUBgoqhkiG%2BE0B%0ADQEEBAYQYGoAAAAwDwYKKoZIhvhNAQ0BBQoBATAeBgoqhkiG%2BE0BDQEGBBDjJ4f6%0AieS5MJrtZWT28t9KMEQGCiqGSIb4TQENAQcwNjAQBgsqhkiG%2BE0BDQEHAQEB%2FzAQ%0ABgsqhkiG%2BE0BDQEHAgEBADAQBgsqhkiG%2BE0BDQEHAwEB%2FzAKBggqhkjOPQQDAgNI%0AADBFAiBJwRZ5Dkvmz41SMH%2FFojZqiPxfzpQo78iqcvTdo0DwTQIhAPzZkuFcwZUV%0Al0yBja8lgLWp%2F8eMKpx5hOAw1dDV2iST%0A-----END%20CERTIFICATE-----%0A",
	}

	db.QEIdentityRepository().Create(qeIdentity)

	err = refreshNonPCKCollaterals(db, conf, &client)
	assert.Nil(t, err)
}

func TestIsCoolOffTimeout(t *testing.T) {
	lastRefresh := &types.LastRefresh{
		CompletedAt: time.Now().Add(-1 * time.Hour),
	}

	isCoolOffTimeout(lastRefresh)
}

func TestFetchLastRefreshInfo(t *testing.T) {
	db := getMockDatabase()
	got, err := fetchLastRefreshInfo(db)
	assert.Nil(t, got, err)
}

func TestCachePckCrlInfo(t *testing.T) {

	db := getMockDatabase()
	pckCrl := &types.PckCrl{
		Ca:              "processor",
		PckCrlCertChain: "-----BEGIN%20CERTIFICATE-----%0AMIIE9DCCBJqgAwIBAgIUb6rZwuxZc5cIkp6%2Foqqz7HdGyFwwCgYIKoZIzj0EAwIw%0AcDEiMCAGA1UEAwwZSW50ZWwgU0dYIFBDSyBQbGF0Zm9ybSBDQTEaMBgGA1UECgwR%0ASW50ZWwgQ29ycG9yYXRpb24xFDASBgNVBAcMC1NhbnRhIENsYXJhMQswCQYDVQQI%0ADAJDQTELMAkGA1UEBhMCVVMwHhcNMjIwNjIxMTEyNDU2WhcNMjkwNjIxMTEyNDU2%0AWjBwMSIwIAYDVQQDDBlJbnRlbCBTR1ggUENLIENlcnRpZmljYXRlMRowGAYDVQQK%0ADBFJbnRlbCBDb3Jwb3JhdGlvbjEUMBIGA1UEBwwLU2FudGEgQ2xhcmExCzAJBgNV%0ABAgMAkNBMQswCQYDVQQGEwJVUzBZMBMGByqGSM49AgEGCCqGSM49AwEHA0IABOB3%0AWFm1ziJAlu79StgxfAuz8AWCkoiraneuAGgrFExeiukczJvjWdtDTM2O7w8GiZAt%0A1h84AyDRUb%2BHoNaflACjggMQMIIDDDAfBgNVHSMEGDAWgBRZI9OnSqhjVC45cK3g%0ADwcrVyQqtzBvBgNVHR8EaDBmMGSgYqBghl5odHRwczovL3NieC5hcGkudHJ1c3Rl%0AZHNlcnZpY2VzLmludGVsLmNvbS9zZ3gvY2VydGlmaWNhdGlvbi92My9wY2tjcmw%2F%0AY2E9cGxhdGZvcm0mZW5jb2Rpbmc9ZGVyMB0GA1UdDgQWBBQ6mE6WHjgoVSRiUaG%2F%0A0QmQDpX7LjAOBgNVHQ8BAf8EBAMCBsAwDAYDVR0TAQH%2FBAIwADCCAjkGCSqGSIb4%0ATQENAQSCAiowggImMB4GCiqGSIb4TQENAQEEEGzzoSC5Btq3aBE%2BWYxHhwUwggFj%0ABgoqhkiG%2BE0BDQECMIIBUzAQBgsqhkiG%2BE0BDQECAQIBATAQBgsqhkiG%2BE0BDQEC%0AAgIBATAQBgsqhkiG%2BE0BDQECAwIBADAQBgsqhkiG%2BE0BDQECBAIBADAQBgsqhkiG%0A%2BE0BDQECBQIBADAQBgsqhkiG%2BE0BDQECBgIBADAQBgsqhkiG%2BE0BDQECBwIBADAQ%0ABgsqhkiG%2BE0BDQECCAIBADAQBgsqhkiG%2BE0BDQECCQIBADAQBgsqhkiG%2BE0BDQEC%0ACgIBADAQBgsqhkiG%2BE0BDQECCwIBADAQBgsqhkiG%2BE0BDQECDAIBADAQBgsqhkiG%0A%2BE0BDQECDQIBADAQBgsqhkiG%2BE0BDQECDgIBADAQBgsqhkiG%2BE0BDQECDwIBADAQ%0ABgsqhkiG%2BE0BDQECEAIBADAQBgsqhkiG%2BE0BDQECEQIBCTAfBgsqhkiG%2BE0BDQEC%0AEgQQAQEAAAAAAAAAAAAAAAAAADAQBgoqhkiG%2BE0BDQEDBAIAADAUBgoqhkiG%2BE0B%0ADQEEBAYQYGoAAAAwDwYKKoZIhvhNAQ0BBQoBATAeBgoqhkiG%2BE0BDQEGBBDjJ4f6%0AieS5MJrtZWT28t9KMEQGCiqGSIb4TQENAQcwNjAQBgsqhkiG%2BE0BDQEHAQEB%2FzAQ%0ABgsqhkiG%2BE0BDQEHAgEBADAQBgsqhkiG%2BE0BDQEHAwEB%2FzAKBggqhkjOPQQDAgNI%0AADBFAiBJwRZ5Dkvmz41SMH%2FFojZqiPxfzpQo78iqcvTdo0DwTQIhAPzZkuFcwZUV%0Al0yBja8lgLWp%2F8eMKpx5hOAw1dDV2iST%0A-----END%20CERTIFICATE-----%0A",
	}
	_, err := cachePckCrlInfo(db, pckCrl, constants.CacheRefresh)
	assert.Nil(t, err)

	_, err = cachePckCrlInfo(db, pckCrl, constants.CacheInsert)
	assert.Nil(t, err)

	pckCrl.Ca = ""
	pckCrl.PckCrlCertChain = ""
	_, err = cachePckCrlInfo(db, pckCrl, constants.CacheRefresh)
	assert.NotNil(t, err)

	db.PckCrlRepository().Create(pckCrl)
	_, err = cachePckCrlInfo(db, pckCrl, constants.CacheInsert)
	assert.NotNil(t, err)
}

func TestCacheFmspcTcbInfo(t *testing.T) {
	db := getMockDatabase()
	var tcbInfoJson TcbInfoJSON

	json.Unmarshal(testTcbInfoJson, &tcbInfoJson)

	tcbInfo := &types.FmspcTcbInfo{
		Fmspc:   "20606a000000",
		TcbInfo: string(testTcbInfoJson),
	}

	_, err := cacheFmspcTcbInfo(db, tcbInfo, constants.CacheRefresh)
	assert.Nil(t, err)

	_, err = cacheFmspcTcbInfo(db, tcbInfo, constants.CacheInsert)
	assert.Nil(t, err)

	db.FmspcTcbInfoRepository().Create(tcbInfo)
	_, err = cacheFmspcTcbInfo(db, tcbInfo, constants.CacheInsert)
	assert.NotNil(t, err)

	tcbInfo.Fmspc = ""
	_, err = cacheFmspcTcbInfo(db, tcbInfo, constants.CacheRefresh)
	assert.NotNil(t, err)

}

func TestCacheQeIdentityInfo(t *testing.T) {
	db := getMockDatabase()
	qeIdentity := &types.QEIdentity{
		ID:            "73d1aac0-83db-4c40-8c11-6dfe5d4f4f0e",
		QeInfo:        string(qeInfo),
		QeIssuerChain: "-----BEGIN%20CERTIFICATE-----%0AMIIE9DCCBJqgAwIBAgIUb6rZwuxZc5cIkp6%2Foqqz7HdGyFwwCgYIKoZIzj0EAwIw%0AcDEiMCAGA1UEAwwZSW50ZWwgU0dYIFBDSyBQbGF0Zm9ybSBDQTEaMBgGA1UECgwR%0ASW50ZWwgQ29ycG9yYXRpb24xFDASBgNVBAcMC1NhbnRhIENsYXJhMQswCQYDVQQI%0ADAJDQTELMAkGA1UEBhMCVVMwHhcNMjIwNjIxMTEyNDU2WhcNMjkwNjIxMTEyNDU2%0AWjBwMSIwIAYDVQQDDBlJbnRlbCBTR1ggUENLIENlcnRpZmljYXRlMRowGAYDVQQK%0ADBFJbnRlbCBDb3Jwb3JhdGlvbjEUMBIGA1UEBwwLU2FudGEgQ2xhcmExCzAJBgNV%0ABAgMAkNBMQswCQYDVQQGEwJVUzBZMBMGByqGSM49AgEGCCqGSM49AwEHA0IABOB3%0AWFm1ziJAlu79StgxfAuz8AWCkoiraneuAGgrFExeiukczJvjWdtDTM2O7w8GiZAt%0A1h84AyDRUb%2BHoNaflACjggMQMIIDDDAfBgNVHSMEGDAWgBRZI9OnSqhjVC45cK3g%0ADwcrVyQqtzBvBgNVHR8EaDBmMGSgYqBghl5odHRwczovL3NieC5hcGkudHJ1c3Rl%0AZHNlcnZpY2VzLmludGVsLmNvbS9zZ3gvY2VydGlmaWNhdGlvbi92My9wY2tjcmw%2F%0AY2E9cGxhdGZvcm0mZW5jb2Rpbmc9ZGVyMB0GA1UdDgQWBBQ6mE6WHjgoVSRiUaG%2F%0A0QmQDpX7LjAOBgNVHQ8BAf8EBAMCBsAwDAYDVR0TAQH%2FBAIwADCCAjkGCSqGSIb4%0ATQENAQSCAiowggImMB4GCiqGSIb4TQENAQEEEGzzoSC5Btq3aBE%2BWYxHhwUwggFj%0ABgoqhkiG%2BE0BDQECMIIBUzAQBgsqhkiG%2BE0BDQECAQIBATAQBgsqhkiG%2BE0BDQEC%0AAgIBATAQBgsqhkiG%2BE0BDQECAwIBADAQBgsqhkiG%2BE0BDQECBAIBADAQBgsqhkiG%0A%2BE0BDQECBQIBADAQBgsqhkiG%2BE0BDQECBgIBADAQBgsqhkiG%2BE0BDQECBwIBADAQ%0ABgsqhkiG%2BE0BDQECCAIBADAQBgsqhkiG%2BE0BDQECCQIBADAQBgsqhkiG%2BE0BDQEC%0ACgIBADAQBgsqhkiG%2BE0BDQECCwIBADAQBgsqhkiG%2BE0BDQECDAIBADAQBgsqhkiG%0A%2BE0BDQECDQIBADAQBgsqhkiG%2BE0BDQECDgIBADAQBgsqhkiG%2BE0BDQECDwIBADAQ%0ABgsqhkiG%2BE0BDQECEAIBADAQBgsqhkiG%2BE0BDQECEQIBCTAfBgsqhkiG%2BE0BDQEC%0AEgQQAQEAAAAAAAAAAAAAAAAAADAQBgoqhkiG%2BE0BDQEDBAIAADAUBgoqhkiG%2BE0B%0ADQEEBAYQYGoAAAAwDwYKKoZIhvhNAQ0BBQoBATAeBgoqhkiG%2BE0BDQEGBBDjJ4f6%0AieS5MJrtZWT28t9KMEQGCiqGSIb4TQENAQcwNjAQBgsqhkiG%2BE0BDQEHAQEB%2FzAQ%0ABgsqhkiG%2BE0BDQEHAgEBADAQBgsqhkiG%2BE0BDQEHAwEB%2FzAKBggqhkjOPQQDAgNI%0AADBFAiBJwRZ5Dkvmz41SMH%2FFojZqiPxfzpQo78iqcvTdo0DwTQIhAPzZkuFcwZUV%0Al0yBja8lgLWp%2F8eMKpx5hOAw1dDV2iST%0A-----END%20CERTIFICATE-----%0A",
	}

	_, err := cacheQeIdentityInfo(db, qeIdentity, constants.CacheRefresh)
	assert.Nil(t, err)

	_, err = cacheQeIdentityInfo(db, qeIdentity, constants.CacheInsert)
	assert.Nil(t, err)

	// negative tests
	db.QEIdentityRepository().Create(qeIdentity)
	_, err = cacheQeIdentityInfo(db, qeIdentity, constants.CacheInsert)
	assert.NotNil(t, err)

	qeIdentity.QeInfo = ""
	_, err = cacheQeIdentityInfo(db, qeIdentity, constants.CacheRefresh)
	assert.NotNil(t, err)
}

func TestInitAutoRefreshTimer(t *testing.T) {
	db := getMockDatabase()
	refreshTrigger := make(chan constants.RefreshTrigger)
	err := InitAutoRefreshTimer(db, refreshTrigger, 1)
	assert.Nil(t, err)
}

func TestWithNegativeCases(t *testing.T) {
	conf := config.Load(testConfigFilePath)
	client := mocks.NewClientMock(400)

	_, err := fetchPckCrlInfo("processor", conf, &client)
	assert.NotNil(t, err)

	_, err = fetchFmspcTcbInfo("0387928700021483000", conf, &client)
	assert.NotNil(t, err)

	_, err = fetchQeIdentityInfo(conf, &client)
	assert.NotNil(t, err)

	client = mocks.NewClientMock(201)
	_, err = fetchPckCrlInfo("processor", conf, &client)
	assert.NotNil(t, err)
	_, err = fetchFmspcTcbInfo("0387928700021483000", conf, &client)
	assert.NotNil(t, err)
	_, err = fetchQeIdentityInfo(conf, &client)
	assert.NotNil(t, err)

	client = mocks.NewClientMock(204)
	_, err = fetchPckCrlInfo("processor", conf, &client)
	assert.NotNil(t, err)
	_, err = fetchFmspcTcbInfo("0387928700021483000", conf, &client)
	assert.NotNil(t, err)
	_, err = fetchQeIdentityInfo(conf, &client)
	assert.NotNil(t, err)

	client = mocks.NewClientMock(205)
	_, err = fetchPckCrlInfo("processor", conf, &client)
	assert.NotNil(t, err)
	_, err = fetchFmspcTcbInfo("0387928700021483000", conf, &client)
	assert.NotNil(t, err)
	_, err = fetchQeIdentityInfo(conf, &client)
	assert.NotNil(t, err)

}
