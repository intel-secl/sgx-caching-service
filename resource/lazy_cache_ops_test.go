/*
 * Copyright (C) 2020 Intel Corporation
 * SPDX-License-Identifier: BSD-3-Clause
 */
package resource

import (
	"encoding/json"
	"intel/isecl/scs/v5/config"
	"intel/isecl/scs/v5/constants"
	"intel/isecl/scs/v5/domain"
	"intel/isecl/scs/v5/domain/mocks"
	"intel/isecl/scs/v5/repository/postgres/mock"
	"intel/isecl/scs/v5/types"
	"testing"

	"github.com/google/uuid"
	"github.com/stretchr/testify/assert"
)

func TestGetLazyCachePckCert(t *testing.T) {
	var conf *config.Configuration
	var client domain.HttpClient

	db := getMockDatabase()
	conf = config.Load(testConfigFilePath)
	client = mocks.NewClientMock(200)

	newPckCert := &types.PckCert{
		QeID:      "0518145496973c5e69577195511e9080",
		PceID:     "0000",
		CertIndex: 0,
		Tcbms:     []string{"030300000000000000000000000000000A00"},
		Fmspc:     "20606a000000",
		PckCerts:  []string{"-----BEGIN%20CERTIFICATE-----%0AMIIE9DCCBJqgAwIBAgIUb6rZwuxZc5cIkp6%2Foqqz7HdGyFwwCgYIKoZIzj0EAwIw%0AcDEiMCAGA1UEAwwZSW50ZWwgU0dYIFBDSyBQbGF0Zm9ybSBDQTEaMBgGA1UECgwR%0ASW50ZWwgQ29ycG9yYXRpb24xFDASBgNVBAcMC1NhbnRhIENsYXJhMQswCQYDVQQI%0ADAJDQTELMAkGA1UEBhMCVVMwHhcNMjIwNjIxMTEyNDU2WhcNMjkwNjIxMTEyNDU2%0AWjBwMSIwIAYDVQQDDBlJbnRlbCBTR1ggUENLIENlcnRpZmljYXRlMRowGAYDVQQK%0ADBFJbnRlbCBDb3Jwb3JhdGlvbjEUMBIGA1UEBwwLU2FudGEgQ2xhcmExCzAJBgNV%0ABAgMAkNBMQswCQYDVQQGEwJVUzBZMBMGByqGSM49AgEGCCqGSM49AwEHA0IABOB3%0AWFm1ziJAlu79StgxfAuz8AWCkoiraneuAGgrFExeiukczJvjWdtDTM2O7w8GiZAt%0A1h84AyDRUb%2BHoNaflACjggMQMIIDDDAfBgNVHSMEGDAWgBRZI9OnSqhjVC45cK3g%0ADwcrVyQqtzBvBgNVHR8EaDBmMGSgYqBghl5odHRwczovL3NieC5hcGkudHJ1c3Rl%0AZHNlcnZpY2VzLmludGVsLmNvbS9zZ3gvY2VydGlmaWNhdGlvbi92My9wY2tjcmw%2F%0AY2E9cGxhdGZvcm0mZW5jb2Rpbmc9ZGVyMB0GA1UdDgQWBBQ6mE6WHjgoVSRiUaG%2F%0A0QmQDpX7LjAOBgNVHQ8BAf8EBAMCBsAwDAYDVR0TAQH%2FBAIwADCCAjkGCSqGSIb4%0ATQENAQSCAiowggImMB4GCiqGSIb4TQENAQEEEGzzoSC5Btq3aBE%2BWYxHhwUwggFj%0ABgoqhkiG%2BE0BDQECMIIBUzAQBgsqhkiG%2BE0BDQECAQIBATAQBgsqhkiG%2BE0BDQEC%0AAgIBATAQBgsqhkiG%2BE0BDQECAwIBADAQBgsqhkiG%2BE0BDQECBAIBADAQBgsqhkiG%0A%2BE0BDQECBQIBADAQBgsqhkiG%2BE0BDQECBgIBADAQBgsqhkiG%2BE0BDQECBwIBADAQ%0ABgsqhkiG%2BE0BDQECCAIBADAQBgsqhkiG%2BE0BDQECCQIBADAQBgsqhkiG%2BE0BDQEC%0ACgIBADAQBgsqhkiG%2BE0BDQECCwIBADAQBgsqhkiG%2BE0BDQECDAIBADAQBgsqhkiG%0A%2BE0BDQECDQIBADAQBgsqhkiG%2BE0BDQECDgIBADAQBgsqhkiG%2BE0BDQECDwIBADAQ%0ABgsqhkiG%2BE0BDQECEAIBADAQBgsqhkiG%2BE0BDQECEQIBCTAfBgsqhkiG%2BE0BDQEC%0AEgQQAQEAAAAAAAAAAAAAAAAAADAQBgoqhkiG%2BE0BDQEDBAIAADAUBgoqhkiG%2BE0B%0ADQEEBAYQYGoAAAAwDwYKKoZIhvhNAQ0BBQoBATAeBgoqhkiG%2BE0BDQEGBBDjJ4f6%0AieS5MJrtZWT28t9KMEQGCiqGSIb4TQENAQcwNjAQBgsqhkiG%2BE0BDQEHAQEB%2FzAQ%0ABgsqhkiG%2BE0BDQEHAgEBADAQBgsqhkiG%2BE0BDQEHAwEB%2FzAKBggqhkjOPQQDAgNI%0AADBFAiBJwRZ5Dkvmz41SMH%2FFojZqiPxfzpQo78iqcvTdo0DwTQIhAPzZkuFcwZUV%0Al0yBja8lgLWp%2F8eMKpx5hOAw1dDV2iST%0A-----END%20CERTIFICATE-----%0A"},
	}
	db.PckCertRepository().Create(newPckCert)

	platform := &types.Platform{
		QeID:     "0518145496973c5e69577195511e9080",
		PceID:    "0000",
		CPUSvn:   "1bf8deed6f929ce40bd658e61ea722eb",
		PceSvn:   "0a00",
		Encppid:  "00f51b4272163732be2101ee62dfdb175205a5179c5b5faff4b2ae103cb1150ef7d4e6041775543930600e41dd2e6aee7f40790f5a0380f6b29b1f1f7e6aad75bfa666153bb325c6db5b67f694d14bff98996c4994ce153278bfeb1b455dd4acbeacc97df6a3cd439a838218c1e07dae91a62195b803b9d3808d5b8470d46b0af3f275b6f6573871eb4eeb43ed9c5a5647729f25648fa74f1ce43621618b266abde6f44e92ce65bbbbe2c50e3e7a8b84d1ed38f53a1d99d3f15fc8c39b0ee568580c37a4eb19dbe87cd447c78f05544684701c01e64e0273dc69c27e46f732f7a7ee8cc4dfaf3b921bf6bbc3ee83f8de5f4e86039595cddaf7cadfce599f0eb92509ff2a90d189bda51fdd298fa1cffd4e8d79095f104c073a2b71cf61c727f4e5718cb7ea2f8fc6d7694bf3b40764234dfbe0d35f40f557545e1729ca639be4f1bcdc9028cb590b3ad3fd176bfea3cef13e57db057b3bae7ae8553a454515aecb21e4c58c670b19d8ee12668ab8af16d56b285153589eb85d15cd9e56fe459b",
		Fmspc:    "20606a000000",
		Ca:       "processor",
		Manifest: "178e874b49e44aa599bb3057170925b41d6e010000000000000000000000000084947ac684404189902a7e76cd658926bc010100000000000000000000000000e5db57cfd1af3e45ddfbd7f52e74a44871d542e3893c9f6f88ef999a7969eacc38e156d8233e6479997f6daa3553d902bb6a7fd6e6db21c43c13993c91c2eb95b6654b70d3e1602d5c236f9c5e8209a6a9923f49628eb7ba934913ccee4ae3df1c9ce11d0dac1c2e6ebbeb7b036e1288ad98d0aac44e5dbe3e01ea40eb7301c513c388d7e87b6630fcee23dccc28e5466a3669137e79021e386db75569606a481ac81bcd03fdc30a142bce8cca274dc044f2b40dc9abaef952bb4f0d01058d590d6950cd56bd036c7385272789e38de9b7302fafd5514248de83c18aedc9fb3c4a60754b41d8038be2c85d9e109742450b76989ff262cb0a7a979546018c7c76109ec6dd7965eead462bbd1edf6124e4a7da00de497408e44869496138cc1383f2caef7b6bf456c1f494c2b539e1741d904515414816a5096e96350b5decc84cdb9c29fe6ffa7a1982b55fe6fb258e18f03c1724b296aab446a9f4e10de1d49485f4360dfade7bc6abf70c0f1ed59c15ab30face19e3cfee43e1bee2f2800095576af52b46344ea4e7e08c2bc1d568dd01000100bcf7744b0929b513d15794280f82233b5684b73af7f86c073d1ecec86f6cd34c0000010001000000fd8f5c411b614b97a74796f08926757b39050100000000000000000000000000200000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
		HwUUID:   uuid.MustParse("ee37c360-7eae-4250-a677-6ee12adce8e2"),
	}

	db.PlatformRepository().Create(platform)

	var tcbInfoJson TcbInfoJSON

	json.Unmarshal(testTcbInfoJson, &tcbInfoJson)

	tcbInfo := &types.FmspcTcbInfo{
		Fmspc:   "20606a000000",
		TcbInfo: string(testTcbInfoJson),
	}
	db.FmspcTcbInfoRepository().Create(tcbInfo)

	certChain := &types.PckCertChain{
		Ca:           "processor",
		PckCertChain: "-----BEGIN%20CERTIFICATE-----%0AMIIE9DCCBJqgAwIBAgIUb6rZwuxZc5cIkp6%2Foqqz7HdGyFwwCgYIKoZIzj0EAwIw%0AcDEiMCAGA1UEAwwZSW50ZWwgU0dYIFBDSyBQbGF0Zm9ybSBDQTEaMBgGA1UECgwR%0ASW50ZWwgQ29ycG9yYXRpb24xFDASBgNVBAcMC1NhbnRhIENsYXJhMQswCQYDVQQI%0ADAJDQTELMAkGA1UEBhMCVVMwHhcNMjIwNjIxMTEyNDU2WhcNMjkwNjIxMTEyNDU2%0AWjBwMSIwIAYDVQQDDBlJbnRlbCBTR1ggUENLIENlcnRpZmljYXRlMRowGAYDVQQK%0ADBFJbnRlbCBDb3Jwb3JhdGlvbjEUMBIGA1UEBwwLU2FudGEgQ2xhcmExCzAJBgNV%0ABAgMAkNBMQswCQYDVQQGEwJVUzBZMBMGByqGSM49AgEGCCqGSM49AwEHA0IABOB3%0AWFm1ziJAlu79StgxfAuz8AWCkoiraneuAGgrFExeiukczJvjWdtDTM2O7w8GiZAt%0A1h84AyDRUb%2BHoNaflACjggMQMIIDDDAfBgNVHSMEGDAWgBRZI9OnSqhjVC45cK3g%0ADwcrVyQqtzBvBgNVHR8EaDBmMGSgYqBghl5odHRwczovL3NieC5hcGkudHJ1c3Rl%0AZHNlcnZpY2VzLmludGVsLmNvbS9zZ3gvY2VydGlmaWNhdGlvbi92My9wY2tjcmw%2F%0AY2E9cGxhdGZvcm0mZW5jb2Rpbmc9ZGVyMB0GA1UdDgQWBBQ6mE6WHjgoVSRiUaG%2F%0A0QmQDpX7LjAOBgNVHQ8BAf8EBAMCBsAwDAYDVR0TAQH%2FBAIwADCCAjkGCSqGSIb4%0ATQENAQSCAiowggImMB4GCiqGSIb4TQENAQEEEGzzoSC5Btq3aBE%2BWYxHhwUwggFj%0ABgoqhkiG%2BE0BDQECMIIBUzAQBgsqhkiG%2BE0BDQECAQIBATAQBgsqhkiG%2BE0BDQEC%0AAgIBATAQBgsqhkiG%2BE0BDQECAwIBADAQBgsqhkiG%2BE0BDQECBAIBADAQBgsqhkiG%0A%2BE0BDQECBQIBADAQBgsqhkiG%2BE0BDQECBgIBADAQBgsqhkiG%2BE0BDQECBwIBADAQ%0ABgsqhkiG%2BE0BDQECCAIBADAQBgsqhkiG%2BE0BDQECCQIBADAQBgsqhkiG%2BE0BDQEC%0ACgIBADAQBgsqhkiG%2BE0BDQECCwIBADAQBgsqhkiG%2BE0BDQECDAIBADAQBgsqhkiG%0A%2BE0BDQECDQIBADAQBgsqhkiG%2BE0BDQECDgIBADAQBgsqhkiG%2BE0BDQECDwIBADAQ%0ABgsqhkiG%2BE0BDQECEAIBADAQBgsqhkiG%2BE0BDQECEQIBCTAfBgsqhkiG%2BE0BDQEC%0AEgQQAQEAAAAAAAAAAAAAAAAAADAQBgoqhkiG%2BE0BDQEDBAIAADAUBgoqhkiG%2BE0B%0ADQEEBAYQYGoAAAAwDwYKKoZIhvhNAQ0BBQoBATAeBgoqhkiG%2BE0BDQEGBBDjJ4f6%0AieS5MJrtZWT28t9KMEQGCiqGSIb4TQENAQcwNjAQBgsqhkiG%2BE0BDQEHAQEB%2FzAQ%0ABgsqhkiG%2BE0BDQEHAgEBADAQBgsqhkiG%2BE0BDQEHAwEB%2FzAKBggqhkjOPQQDAgNI%0AADBFAiBJwRZ5Dkvmz41SMH%2FFojZqiPxfzpQo78iqcvTdo0DwTQIhAPzZkuFcwZUV%0Al0yBja8lgLWp%2F8eMKpx5hOAw1dDV2iST%0A-----END%20CERTIFICATE-----%0A",
	}

	db.PckCertChainRepository().Create(certChain)

	pInfo := &types.Platform{QeID: "0518145496973c5e69577195511e9080", PceID: "0000"}

	// getLazyCachePckCert API will get PCK Certs and will cache it as well.
	_, _, _, err := getLazyCachePckCert(db, platform, constants.CacheInsert, conf, &client)
	assert.NotNil(t, err)

	platform.Manifest = ""
	_, _, _, err = getLazyCachePckCert(db, platform, constants.CacheInsert, conf, &client)
	assert.NotNil(t, err)

	_, _, _, err = getLazyCachePckCert(db, pInfo, constants.CacheInsert, conf, &client)
	assert.NotNil(t, err)
}

func TestGetLazyCachePckCrl(t *testing.T) {
	var conf *config.Configuration
	var client domain.HttpClient

	db := getMockDatabase()
	conf = config.Load(testConfigFilePath)
	client = mocks.NewClientMock(200)

	newPckCert := &types.PckCert{
		QeID:      "0518145496973c5e69577195511e9080",
		PceID:     "0000",
		CertIndex: 0,
		Tcbms:     []string{"030300000000000000000000000000000A00"},
		Fmspc:     "20606a000000",
		PckCerts:  []string{"-----BEGIN%20CERTIFICATE-----%0AMIIE9DCCBJqgAwIBAgIUb6rZwuxZc5cIkp6%2Foqqz7HdGyFwwCgYIKoZIzj0EAwIw%0AcDEiMCAGA1UEAwwZSW50ZWwgU0dYIFBDSyBQbGF0Zm9ybSBDQTEaMBgGA1UECgwR%0ASW50ZWwgQ29ycG9yYXRpb24xFDASBgNVBAcMC1NhbnRhIENsYXJhMQswCQYDVQQI%0ADAJDQTELMAkGA1UEBhMCVVMwHhcNMjIwNjIxMTEyNDU2WhcNMjkwNjIxMTEyNDU2%0AWjBwMSIwIAYDVQQDDBlJbnRlbCBTR1ggUENLIENlcnRpZmljYXRlMRowGAYDVQQK%0ADBFJbnRlbCBDb3Jwb3JhdGlvbjEUMBIGA1UEBwwLU2FudGEgQ2xhcmExCzAJBgNV%0ABAgMAkNBMQswCQYDVQQGEwJVUzBZMBMGByqGSM49AgEGCCqGSM49AwEHA0IABOB3%0AWFm1ziJAlu79StgxfAuz8AWCkoiraneuAGgrFExeiukczJvjWdtDTM2O7w8GiZAt%0A1h84AyDRUb%2BHoNaflACjggMQMIIDDDAfBgNVHSMEGDAWgBRZI9OnSqhjVC45cK3g%0ADwcrVyQqtzBvBgNVHR8EaDBmMGSgYqBghl5odHRwczovL3NieC5hcGkudHJ1c3Rl%0AZHNlcnZpY2VzLmludGVsLmNvbS9zZ3gvY2VydGlmaWNhdGlvbi92My9wY2tjcmw%2F%0AY2E9cGxhdGZvcm0mZW5jb2Rpbmc9ZGVyMB0GA1UdDgQWBBQ6mE6WHjgoVSRiUaG%2F%0A0QmQDpX7LjAOBgNVHQ8BAf8EBAMCBsAwDAYDVR0TAQH%2FBAIwADCCAjkGCSqGSIb4%0ATQENAQSCAiowggImMB4GCiqGSIb4TQENAQEEEGzzoSC5Btq3aBE%2BWYxHhwUwggFj%0ABgoqhkiG%2BE0BDQECMIIBUzAQBgsqhkiG%2BE0BDQECAQIBATAQBgsqhkiG%2BE0BDQEC%0AAgIBATAQBgsqhkiG%2BE0BDQECAwIBADAQBgsqhkiG%2BE0BDQECBAIBADAQBgsqhkiG%0A%2BE0BDQECBQIBADAQBgsqhkiG%2BE0BDQECBgIBADAQBgsqhkiG%2BE0BDQECBwIBADAQ%0ABgsqhkiG%2BE0BDQECCAIBADAQBgsqhkiG%2BE0BDQECCQIBADAQBgsqhkiG%2BE0BDQEC%0ACgIBADAQBgsqhkiG%2BE0BDQECCwIBADAQBgsqhkiG%2BE0BDQECDAIBADAQBgsqhkiG%0A%2BE0BDQECDQIBADAQBgsqhkiG%2BE0BDQECDgIBADAQBgsqhkiG%2BE0BDQECDwIBADAQ%0ABgsqhkiG%2BE0BDQECEAIBADAQBgsqhkiG%2BE0BDQECEQIBCTAfBgsqhkiG%2BE0BDQEC%0AEgQQAQEAAAAAAAAAAAAAAAAAADAQBgoqhkiG%2BE0BDQEDBAIAADAUBgoqhkiG%2BE0B%0ADQEEBAYQYGoAAAAwDwYKKoZIhvhNAQ0BBQoBATAeBgoqhkiG%2BE0BDQEGBBDjJ4f6%0AieS5MJrtZWT28t9KMEQGCiqGSIb4TQENAQcwNjAQBgsqhkiG%2BE0BDQEHAQEB%2FzAQ%0ABgsqhkiG%2BE0BDQEHAgEBADAQBgsqhkiG%2BE0BDQEHAwEB%2FzAKBggqhkjOPQQDAgNI%0AADBFAiBJwRZ5Dkvmz41SMH%2FFojZqiPxfzpQo78iqcvTdo0DwTQIhAPzZkuFcwZUV%0Al0yBja8lgLWp%2F8eMKpx5hOAw1dDV2iST%0A-----END%20CERTIFICATE-----%0A"},
	}
	db.PckCertRepository().Create(newPckCert)

	platform := &types.Platform{
		QeID:     "0518145496973c5e69577195511e9080",
		PceID:    "0000",
		CPUSvn:   "1bf8deed6f929ce40bd658e61ea722eb",
		PceSvn:   "0a00",
		Encppid:  "00f51b4272163732be2101ee62dfdb175205a5179c5b5faff4b2ae103cb1150ef7d4e6041775543930600e41dd2e6aee7f40790f5a0380f6b29b1f1f7e6aad75bfa666153bb325c6db5b67f694d14bff98996c4994ce153278bfeb1b455dd4acbeacc97df6a3cd439a838218c1e07dae91a62195b803b9d3808d5b8470d46b0af3f275b6f6573871eb4eeb43ed9c5a5647729f25648fa74f1ce43621618b266abde6f44e92ce65bbbbe2c50e3e7a8b84d1ed38f53a1d99d3f15fc8c39b0ee568580c37a4eb19dbe87cd447c78f05544684701c01e64e0273dc69c27e46f732f7a7ee8cc4dfaf3b921bf6bbc3ee83f8de5f4e86039595cddaf7cadfce599f0eb92509ff2a90d189bda51fdd298fa1cffd4e8d79095f104c073a2b71cf61c727f4e5718cb7ea2f8fc6d7694bf3b40764234dfbe0d35f40f557545e1729ca639be4f1bcdc9028cb590b3ad3fd176bfea3cef13e57db057b3bae7ae8553a454515aecb21e4c58c670b19d8ee12668ab8af16d56b285153589eb85d15cd9e56fe459b",
		Fmspc:    "20606a000000",
		Ca:       "processor",
		Manifest: "178e874b49e44aa599bb3057170925b41d6e010000000000000000000000000084947ac684404189902a7e76cd658926bc010100000000000000000000000000e5db57cfd1af3e45ddfbd7f52e74a44871d542e3893c9f6f88ef999a7969eacc38e156d8233e6479997f6daa3553d902bb6a7fd6e6db21c43c13993c91c2eb95b6654b70d3e1602d5c236f9c5e8209a6a9923f49628eb7ba934913ccee4ae3df1c9ce11d0dac1c2e6ebbeb7b036e1288ad98d0aac44e5dbe3e01ea40eb7301c513c388d7e87b6630fcee23dccc28e5466a3669137e79021e386db75569606a481ac81bcd03fdc30a142bce8cca274dc044f2b40dc9abaef952bb4f0d01058d590d6950cd56bd036c7385272789e38de9b7302fafd5514248de83c18aedc9fb3c4a60754b41d8038be2c85d9e109742450b76989ff262cb0a7a979546018c7c76109ec6dd7965eead462bbd1edf6124e4a7da00de497408e44869496138cc1383f2caef7b6bf456c1f494c2b539e1741d904515414816a5096e96350b5decc84cdb9c29fe6ffa7a1982b55fe6fb258e18f03c1724b296aab446a9f4e10de1d49485f4360dfade7bc6abf70c0f1ed59c15ab30face19e3cfee43e1bee2f2800095576af52b46344ea4e7e08c2bc1d568dd01000100bcf7744b0929b513d15794280f82233b5684b73af7f86c073d1ecec86f6cd34c0000010001000000fd8f5c411b614b97a74796f08926757b39050100000000000000000000000000200000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
		HwUUID:   uuid.MustParse("ee37c360-7eae-4250-a677-6ee12adce8e2"),
	}

	db.PlatformRepository().Create(platform)

	var tcbInfoJson TcbInfoJSON

	json.Unmarshal(testTcbInfoJson, &tcbInfoJson)

	tcbInfo := &types.FmspcTcbInfo{
		Fmspc:   "20606a000000",
		TcbInfo: string(testTcbInfoJson),
	}
	db.FmspcTcbInfoRepository().Create(tcbInfo)

	certChain := &types.PckCertChain{
		Ca:           "processor",
		PckCertChain: "-----BEGIN%20CERTIFICATE-----%0AMIIE9DCCBJqgAwIBAgIUb6rZwuxZc5cIkp6%2Foqqz7HdGyFwwCgYIKoZIzj0EAwIw%0AcDEiMCAGA1UEAwwZSW50ZWwgU0dYIFBDSyBQbGF0Zm9ybSBDQTEaMBgGA1UECgwR%0ASW50ZWwgQ29ycG9yYXRpb24xFDASBgNVBAcMC1NhbnRhIENsYXJhMQswCQYDVQQI%0ADAJDQTELMAkGA1UEBhMCVVMwHhcNMjIwNjIxMTEyNDU2WhcNMjkwNjIxMTEyNDU2%0AWjBwMSIwIAYDVQQDDBlJbnRlbCBTR1ggUENLIENlcnRpZmljYXRlMRowGAYDVQQK%0ADBFJbnRlbCBDb3Jwb3JhdGlvbjEUMBIGA1UEBwwLU2FudGEgQ2xhcmExCzAJBgNV%0ABAgMAkNBMQswCQYDVQQGEwJVUzBZMBMGByqGSM49AgEGCCqGSM49AwEHA0IABOB3%0AWFm1ziJAlu79StgxfAuz8AWCkoiraneuAGgrFExeiukczJvjWdtDTM2O7w8GiZAt%0A1h84AyDRUb%2BHoNaflACjggMQMIIDDDAfBgNVHSMEGDAWgBRZI9OnSqhjVC45cK3g%0ADwcrVyQqtzBvBgNVHR8EaDBmMGSgYqBghl5odHRwczovL3NieC5hcGkudHJ1c3Rl%0AZHNlcnZpY2VzLmludGVsLmNvbS9zZ3gvY2VydGlmaWNhdGlvbi92My9wY2tjcmw%2F%0AY2E9cGxhdGZvcm0mZW5jb2Rpbmc9ZGVyMB0GA1UdDgQWBBQ6mE6WHjgoVSRiUaG%2F%0A0QmQDpX7LjAOBgNVHQ8BAf8EBAMCBsAwDAYDVR0TAQH%2FBAIwADCCAjkGCSqGSIb4%0ATQENAQSCAiowggImMB4GCiqGSIb4TQENAQEEEGzzoSC5Btq3aBE%2BWYxHhwUwggFj%0ABgoqhkiG%2BE0BDQECMIIBUzAQBgsqhkiG%2BE0BDQECAQIBATAQBgsqhkiG%2BE0BDQEC%0AAgIBATAQBgsqhkiG%2BE0BDQECAwIBADAQBgsqhkiG%2BE0BDQECBAIBADAQBgsqhkiG%0A%2BE0BDQECBQIBADAQBgsqhkiG%2BE0BDQECBgIBADAQBgsqhkiG%2BE0BDQECBwIBADAQ%0ABgsqhkiG%2BE0BDQECCAIBADAQBgsqhkiG%2BE0BDQECCQIBADAQBgsqhkiG%2BE0BDQEC%0ACgIBADAQBgsqhkiG%2BE0BDQECCwIBADAQBgsqhkiG%2BE0BDQECDAIBADAQBgsqhkiG%0A%2BE0BDQECDQIBADAQBgsqhkiG%2BE0BDQECDgIBADAQBgsqhkiG%2BE0BDQECDwIBADAQ%0ABgsqhkiG%2BE0BDQECEAIBADAQBgsqhkiG%2BE0BDQECEQIBCTAfBgsqhkiG%2BE0BDQEC%0AEgQQAQEAAAAAAAAAAAAAAAAAADAQBgoqhkiG%2BE0BDQEDBAIAADAUBgoqhkiG%2BE0B%0ADQEEBAYQYGoAAAAwDwYKKoZIhvhNAQ0BBQoBATAeBgoqhkiG%2BE0BDQEGBBDjJ4f6%0AieS5MJrtZWT28t9KMEQGCiqGSIb4TQENAQcwNjAQBgsqhkiG%2BE0BDQEHAQEB%2FzAQ%0ABgsqhkiG%2BE0BDQEHAgEBADAQBgsqhkiG%2BE0BDQEHAwEB%2FzAKBggqhkjOPQQDAgNI%0AADBFAiBJwRZ5Dkvmz41SMH%2FFojZqiPxfzpQo78iqcvTdo0DwTQIhAPzZkuFcwZUV%0Al0yBja8lgLWp%2F8eMKpx5hOAw1dDV2iST%0A-----END%20CERTIFICATE-----%0A",
	}

	db.PckCertChainRepository().Create(certChain)

	_, err := getLazyCachePckCrl(db, platform.Ca, constants.CacheInsert, conf, &client)
	assert.Nil(t, err)

	_, err = getLazyCachePckCrl(db, platform.Ca, constants.CacheInsert, nil, &client)
	assert.NotNil(t, err)

	_, err = getLazyCachePckCrl(db, platform.Ca, 2, conf, &client)
	assert.Nil(t, err)
}

func TestGetLazyCacheFmspcTcbInfo(t *testing.T) {

	db := &mock.MockDatabase{}
	_, err := getLazyCacheFmspcTcbInfo(db, "20606a000000", constants.CacheInsert, nil, nil)
	assert.NotNil(t, err)

	conf := config.Load(testConfigFilePath)
	_, err = getLazyCacheFmspcTcbInfo(db, "20606a000000", constants.CacheInsert, conf, nil)
	assert.NotNil(t, err)
}

func TestGetLazyCacheQEIdentityInfo(t *testing.T) {
	var conf *config.Configuration
	var client domain.HttpClient

	db := getMockDatabase()
	conf = config.Load(testConfigFilePath)
	client = mocks.NewClientMock(200)

	newPckCert := &types.PckCert{
		QeID:      "0518145496973c5e69577195511e9080",
		PceID:     "0000",
		CertIndex: 0,
		Tcbms:     []string{"030300000000000000000000000000000A00"},
		Fmspc:     "20606a000000",
		PckCerts:  []string{"-----BEGIN%20CERTIFICATE-----%0AMIIE9DCCBJqgAwIBAgIUb6rZwuxZc5cIkp6%2Foqqz7HdGyFwwCgYIKoZIzj0EAwIw%0AcDEiMCAGA1UEAwwZSW50ZWwgU0dYIFBDSyBQbGF0Zm9ybSBDQTEaMBgGA1UECgwR%0ASW50ZWwgQ29ycG9yYXRpb24xFDASBgNVBAcMC1NhbnRhIENsYXJhMQswCQYDVQQI%0ADAJDQTELMAkGA1UEBhMCVVMwHhcNMjIwNjIxMTEyNDU2WhcNMjkwNjIxMTEyNDU2%0AWjBwMSIwIAYDVQQDDBlJbnRlbCBTR1ggUENLIENlcnRpZmljYXRlMRowGAYDVQQK%0ADBFJbnRlbCBDb3Jwb3JhdGlvbjEUMBIGA1UEBwwLU2FudGEgQ2xhcmExCzAJBgNV%0ABAgMAkNBMQswCQYDVQQGEwJVUzBZMBMGByqGSM49AgEGCCqGSM49AwEHA0IABOB3%0AWFm1ziJAlu79StgxfAuz8AWCkoiraneuAGgrFExeiukczJvjWdtDTM2O7w8GiZAt%0A1h84AyDRUb%2BHoNaflACjggMQMIIDDDAfBgNVHSMEGDAWgBRZI9OnSqhjVC45cK3g%0ADwcrVyQqtzBvBgNVHR8EaDBmMGSgYqBghl5odHRwczovL3NieC5hcGkudHJ1c3Rl%0AZHNlcnZpY2VzLmludGVsLmNvbS9zZ3gvY2VydGlmaWNhdGlvbi92My9wY2tjcmw%2F%0AY2E9cGxhdGZvcm0mZW5jb2Rpbmc9ZGVyMB0GA1UdDgQWBBQ6mE6WHjgoVSRiUaG%2F%0A0QmQDpX7LjAOBgNVHQ8BAf8EBAMCBsAwDAYDVR0TAQH%2FBAIwADCCAjkGCSqGSIb4%0ATQENAQSCAiowggImMB4GCiqGSIb4TQENAQEEEGzzoSC5Btq3aBE%2BWYxHhwUwggFj%0ABgoqhkiG%2BE0BDQECMIIBUzAQBgsqhkiG%2BE0BDQECAQIBATAQBgsqhkiG%2BE0BDQEC%0AAgIBATAQBgsqhkiG%2BE0BDQECAwIBADAQBgsqhkiG%2BE0BDQECBAIBADAQBgsqhkiG%0A%2BE0BDQECBQIBADAQBgsqhkiG%2BE0BDQECBgIBADAQBgsqhkiG%2BE0BDQECBwIBADAQ%0ABgsqhkiG%2BE0BDQECCAIBADAQBgsqhkiG%2BE0BDQECCQIBADAQBgsqhkiG%2BE0BDQEC%0ACgIBADAQBgsqhkiG%2BE0BDQECCwIBADAQBgsqhkiG%2BE0BDQECDAIBADAQBgsqhkiG%0A%2BE0BDQECDQIBADAQBgsqhkiG%2BE0BDQECDgIBADAQBgsqhkiG%2BE0BDQECDwIBADAQ%0ABgsqhkiG%2BE0BDQECEAIBADAQBgsqhkiG%2BE0BDQECEQIBCTAfBgsqhkiG%2BE0BDQEC%0AEgQQAQEAAAAAAAAAAAAAAAAAADAQBgoqhkiG%2BE0BDQEDBAIAADAUBgoqhkiG%2BE0B%0ADQEEBAYQYGoAAAAwDwYKKoZIhvhNAQ0BBQoBATAeBgoqhkiG%2BE0BDQEGBBDjJ4f6%0AieS5MJrtZWT28t9KMEQGCiqGSIb4TQENAQcwNjAQBgsqhkiG%2BE0BDQEHAQEB%2FzAQ%0ABgsqhkiG%2BE0BDQEHAgEBADAQBgsqhkiG%2BE0BDQEHAwEB%2FzAKBggqhkjOPQQDAgNI%0AADBFAiBJwRZ5Dkvmz41SMH%2FFojZqiPxfzpQo78iqcvTdo0DwTQIhAPzZkuFcwZUV%0Al0yBja8lgLWp%2F8eMKpx5hOAw1dDV2iST%0A-----END%20CERTIFICATE-----%0A"},
	}
	db.PckCertRepository().Create(newPckCert)

	platform := &types.Platform{
		QeID:     "0518145496973c5e69577195511e9080",
		PceID:    "0000",
		CPUSvn:   "1bf8deed6f929ce40bd658e61ea722eb",
		PceSvn:   "0a00",
		Encppid:  "00f51b4272163732be2101ee62dfdb175205a5179c5b5faff4b2ae103cb1150ef7d4e6041775543930600e41dd2e6aee7f40790f5a0380f6b29b1f1f7e6aad75bfa666153bb325c6db5b67f694d14bff98996c4994ce153278bfeb1b455dd4acbeacc97df6a3cd439a838218c1e07dae91a62195b803b9d3808d5b8470d46b0af3f275b6f6573871eb4eeb43ed9c5a5647729f25648fa74f1ce43621618b266abde6f44e92ce65bbbbe2c50e3e7a8b84d1ed38f53a1d99d3f15fc8c39b0ee568580c37a4eb19dbe87cd447c78f05544684701c01e64e0273dc69c27e46f732f7a7ee8cc4dfaf3b921bf6bbc3ee83f8de5f4e86039595cddaf7cadfce599f0eb92509ff2a90d189bda51fdd298fa1cffd4e8d79095f104c073a2b71cf61c727f4e5718cb7ea2f8fc6d7694bf3b40764234dfbe0d35f40f557545e1729ca639be4f1bcdc9028cb590b3ad3fd176bfea3cef13e57db057b3bae7ae8553a454515aecb21e4c58c670b19d8ee12668ab8af16d56b285153589eb85d15cd9e56fe459b",
		Fmspc:    "20606a000000",
		Ca:       "processor",
		Manifest: "178e874b49e44aa599bb3057170925b41d6e010000000000000000000000000084947ac684404189902a7e76cd658926bc010100000000000000000000000000e5db57cfd1af3e45ddfbd7f52e74a44871d542e3893c9f6f88ef999a7969eacc38e156d8233e6479997f6daa3553d902bb6a7fd6e6db21c43c13993c91c2eb95b6654b70d3e1602d5c236f9c5e8209a6a9923f49628eb7ba934913ccee4ae3df1c9ce11d0dac1c2e6ebbeb7b036e1288ad98d0aac44e5dbe3e01ea40eb7301c513c388d7e87b6630fcee23dccc28e5466a3669137e79021e386db75569606a481ac81bcd03fdc30a142bce8cca274dc044f2b40dc9abaef952bb4f0d01058d590d6950cd56bd036c7385272789e38de9b7302fafd5514248de83c18aedc9fb3c4a60754b41d8038be2c85d9e109742450b76989ff262cb0a7a979546018c7c76109ec6dd7965eead462bbd1edf6124e4a7da00de497408e44869496138cc1383f2caef7b6bf456c1f494c2b539e1741d904515414816a5096e96350b5decc84cdb9c29fe6ffa7a1982b55fe6fb258e18f03c1724b296aab446a9f4e10de1d49485f4360dfade7bc6abf70c0f1ed59c15ab30face19e3cfee43e1bee2f2800095576af52b46344ea4e7e08c2bc1d568dd01000100bcf7744b0929b513d15794280f82233b5684b73af7f86c073d1ecec86f6cd34c0000010001000000fd8f5c411b614b97a74796f08926757b39050100000000000000000000000000200000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
		HwUUID:   uuid.MustParse("ee37c360-7eae-4250-a677-6ee12adce8e2"),
	}

	db.PlatformRepository().Create(platform)

	var tcbInfoJson TcbInfoJSON

	json.Unmarshal(testTcbInfoJson, &tcbInfoJson)

	tcbInfo := &types.FmspcTcbInfo{
		Fmspc:   "20606a000000",
		TcbInfo: string(testTcbInfoJson),
	}
	db.FmspcTcbInfoRepository().Create(tcbInfo)

	certChain := &types.PckCertChain{
		Ca:           "processor",
		PckCertChain: "-----BEGIN%20CERTIFICATE-----%0AMIIE9DCCBJqgAwIBAgIUb6rZwuxZc5cIkp6%2Foqqz7HdGyFwwCgYIKoZIzj0EAwIw%0AcDEiMCAGA1UEAwwZSW50ZWwgU0dYIFBDSyBQbGF0Zm9ybSBDQTEaMBgGA1UECgwR%0ASW50ZWwgQ29ycG9yYXRpb24xFDASBgNVBAcMC1NhbnRhIENsYXJhMQswCQYDVQQI%0ADAJDQTELMAkGA1UEBhMCVVMwHhcNMjIwNjIxMTEyNDU2WhcNMjkwNjIxMTEyNDU2%0AWjBwMSIwIAYDVQQDDBlJbnRlbCBTR1ggUENLIENlcnRpZmljYXRlMRowGAYDVQQK%0ADBFJbnRlbCBDb3Jwb3JhdGlvbjEUMBIGA1UEBwwLU2FudGEgQ2xhcmExCzAJBgNV%0ABAgMAkNBMQswCQYDVQQGEwJVUzBZMBMGByqGSM49AgEGCCqGSM49AwEHA0IABOB3%0AWFm1ziJAlu79StgxfAuz8AWCkoiraneuAGgrFExeiukczJvjWdtDTM2O7w8GiZAt%0A1h84AyDRUb%2BHoNaflACjggMQMIIDDDAfBgNVHSMEGDAWgBRZI9OnSqhjVC45cK3g%0ADwcrVyQqtzBvBgNVHR8EaDBmMGSgYqBghl5odHRwczovL3NieC5hcGkudHJ1c3Rl%0AZHNlcnZpY2VzLmludGVsLmNvbS9zZ3gvY2VydGlmaWNhdGlvbi92My9wY2tjcmw%2F%0AY2E9cGxhdGZvcm0mZW5jb2Rpbmc9ZGVyMB0GA1UdDgQWBBQ6mE6WHjgoVSRiUaG%2F%0A0QmQDpX7LjAOBgNVHQ8BAf8EBAMCBsAwDAYDVR0TAQH%2FBAIwADCCAjkGCSqGSIb4%0ATQENAQSCAiowggImMB4GCiqGSIb4TQENAQEEEGzzoSC5Btq3aBE%2BWYxHhwUwggFj%0ABgoqhkiG%2BE0BDQECMIIBUzAQBgsqhkiG%2BE0BDQECAQIBATAQBgsqhkiG%2BE0BDQEC%0AAgIBATAQBgsqhkiG%2BE0BDQECAwIBADAQBgsqhkiG%2BE0BDQECBAIBADAQBgsqhkiG%0A%2BE0BDQECBQIBADAQBgsqhkiG%2BE0BDQECBgIBADAQBgsqhkiG%2BE0BDQECBwIBADAQ%0ABgsqhkiG%2BE0BDQECCAIBADAQBgsqhkiG%2BE0BDQECCQIBADAQBgsqhkiG%2BE0BDQEC%0ACgIBADAQBgsqhkiG%2BE0BDQECCwIBADAQBgsqhkiG%2BE0BDQECDAIBADAQBgsqhkiG%0A%2BE0BDQECDQIBADAQBgsqhkiG%2BE0BDQECDgIBADAQBgsqhkiG%2BE0BDQECDwIBADAQ%0ABgsqhkiG%2BE0BDQECEAIBADAQBgsqhkiG%2BE0BDQECEQIBCTAfBgsqhkiG%2BE0BDQEC%0AEgQQAQEAAAAAAAAAAAAAAAAAADAQBgoqhkiG%2BE0BDQEDBAIAADAUBgoqhkiG%2BE0B%0ADQEEBAYQYGoAAAAwDwYKKoZIhvhNAQ0BBQoBATAeBgoqhkiG%2BE0BDQEGBBDjJ4f6%0AieS5MJrtZWT28t9KMEQGCiqGSIb4TQENAQcwNjAQBgsqhkiG%2BE0BDQEHAQEB%2FzAQ%0ABgsqhkiG%2BE0BDQEHAgEBADAQBgsqhkiG%2BE0BDQEHAwEB%2FzAKBggqhkjOPQQDAgNI%0AADBFAiBJwRZ5Dkvmz41SMH%2FFojZqiPxfzpQo78iqcvTdo0DwTQIhAPzZkuFcwZUV%0Al0yBja8lgLWp%2F8eMKpx5hOAw1dDV2iST%0A-----END%20CERTIFICATE-----%0A",
	}

	db.PckCertChainRepository().Create(certChain)
	_, err := getLazyCacheQEIdentityInfo(db, constants.CacheInsert, conf, &client)
	assert.Nil(t, err)
}
